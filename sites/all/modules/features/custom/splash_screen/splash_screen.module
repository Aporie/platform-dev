<?php

/**
 * @file
 * Code for the Splash_screen feature.
 */

/*
 * Implements hook_init()
 */
function splash_screen_init() {
  if (function_exists('drush_main')) return;
  $cookie_name = variable_get('language_cookie_param','language');
  $splash_screen_url = variable_get("splash_screen_url");
  $front = variable_get('site_frontpage', 'node');
  $current = drupal_get_path_alias();

  if (($front == $current) && !isset($_COOKIE[$cookie_name])) {
    drupal_goto($splash_screen_url);
  }
}

/**
 * Implements hook_menu().
 */
function splash_screen_menu() {
  $items['admin/config/splash_screen'] = array(
    'title' => 'Splash screen settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('form_splash_screen_settings'),
    'access arguments' => array('administer splash screen'),
  );
  $items['admin/config/splash_screen/settings'] = array(
    'title' => 'Splash screen settings',
    'description' => 'Configure the splash screen module',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('form_splash_screen_settings'),
    'access arguments' => array('administer splash screen'),
  );
  $items['splash'] = array(
    'title' => t('Please select your language'),
    'page callback' => 'theme',
    'page arguments' => array('splash'),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 *
 */
function form_splash_screen_settings($form, &$form_state) {
  $form['messages'] = array(
    '#type' => 'fieldset',
    '#title' => t('Message settings'),
  );
  $form['messages']['splash_screen_language_msg'] = array(
    '#type' => 'textfield',
    '#title' => t('Choose language'),
    '#default_value' => variable_get("splash_screen_language_msg"),
  );
  $form['URL'] = array(
    '#type' => 'fieldset',
    '#title' => t('Path settings'),
  );
   $form['URL']['splash_screen_url'] = array(
    '#type' => 'textfield',
    '#title' => t('URL of the splash screen'),
    '#default_value' => (variable_get('splash_screen_url')!='node'?drupal_get_path_alias(variable_get('splash_screen_url', 'node')):''),
    '#field_prefix' => url(NULL, array('absolute' => TRUE)) . (variable_get('clean_url', 0) ? '' : '?q='),
  );

  return system_settings_form($form);
}

/**
 * Validates the submitted site-information form.
 */
function form_splash_screen_settings_validate($form, &$form_state) {
  if (empty($form_state['values']['splash_screen_url'])) {
   form_set_error('splash_screen_url', t("Please enter the URL of your splash page"));
  }
  else {
    form_set_value($form['URL']['splash_screen_url'], drupal_get_normal_path($form_state['values']['splash_screen_url']), $form_state);
    if (!drupal_valid_path($form_state['values']['splash_screen_url'])) {
      form_set_error('splash_screen_url', t("The path '%path' is either invalid or you do not have access to it.", array('%path' => $form_state['values']['splash_screen_url'])));
    }
  }
}

/**
 * Implements hook_theme().
 */
function splash_screen_theme($existing, $type, $theme, $path) {
  return array(
    'splash' => array (
      'template' => 'splash',
      'path' => $path . '/theme',
    ),
  );
}

/**
 * Implements hook_permission().
 */
function splash_screen_permission() {
  return array(
    'administer splash screen' => array(
      'title' => t('Administer splash screen'),
      'description' => t('Administrer full settings of the splash screen module.'),
    ),
  );
}
