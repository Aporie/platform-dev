<?php


/**
 * @file
 * multisite_twitterblock definition module.
 */

define("MS_TWEETBLOCK_DEFAULT_TYPE", "smk-twitter_user_timeline");
define("MS_TWEETBLOCK_DEFAULT_SCREEN_NAME", "");
define("MS_TWEETBLOCK_DEFAULT_OWNER_SCREEN_NAME", "");
define("MS_TWEETBLOCK_DEFAULT_SLUG", "");
define("MS_TWEETBLOCK_DEFAULT_INCL_HASHTAGS", "");
define("MS_TWEETBLOCK_DEFAULT_INCL_PROFILES", "");
define("MS_TWEETBLOCK_DEFAULT_EXCL_HASHTAGS", "");
define("MS_TWEETBLOCK_DEFAULT_EXCL_PROFILES", "");
define("MS_TWEETBLOCK_DEFAULT_FROM", "");
define("MS_TWEETBLOCK_DEFAULT_RESTR_LANG_TO", "");
define("MS_TWEETBLOCK_DEFAULT_RESULT_TYPE", "mixed");
define("MS_TWEETBLOCK_DEFAULT_COUNT", 3);
define("MS_TWEETBLOCK_DEFAULT_INCLUDE_RTS", TRUE);
define("MS_TWEETBLOCK_DEFAULT_EXCLUDE_REPLIES", TRUE);
define("MS_TWEETBLOCK_DEFAULT_RTS_DISPLAY_ORIGINAL", TRUE);
define("MS_TWEETBLOCK_DEFAULT_DISPLAY_USER", TRUE);
define("MS_TWEETBLOCK_DEFAULT_DISPLAY_USER_PIC", TRUE);
define("MS_TWEETBLOCK_DEFAULT_AUTO_EXPAND_PHOTO", TRUE);

/**
 * Implements of hook_menu().
 */
function multisite_twitterblock_menu() {
  // Configuration page.
  $items['admin/config/content/multisite_twitterblock/twitter'] = array(
    'title' => 'Multisite Twitter block',
    'description' => 'Configure Multisite Twitter block',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('multisite_twitterblock_admin_settings'),
    'access arguments' => array('administer fpfis twitter widget'),
    'file' => 'multisite_twitterblock.admin.inc',
  );
  return $items;
}

/**
 * Implements of hook_permission().
 */
function multisite_twitterblock_permission() {
  return array(
    'administer fpfis twitter widget' => array(
      'title' => t('Administer Multisite Twitter block settings'),
    ),
    'administer fpfis twitter feature' => array(
      'title' => t('Administer Multisite Twitter content types'),
    ),
    'override fpfis twitter widget' => array(
      'title' => t('Override Multisite Twitter block on select content types'),
    ),
  );
}

/**
 * Implements hook_block_info().
 */
function multisite_twitterblock_block_info() {
  $blocks['fpfis_twitter'] = array(
    'info' => t('Twitter widget'),
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function multisite_twitterblock_block_view($delta = '') {
  $block = array();
  switch ($delta) {
    case 'fpfis_twitter':{
      $config = array();
      // Node override.
      $node = menu_get_object();
      if ($node) {
        node_object_prepare($node);
        if (isset($node->fpfis_twitter_override)) {
          $config = $node->fpfis_twitter_override['config'];
        }
      }
      // Context override.
      $context_settings = multisite_twitterblock_detect_multisite_twitterblock_reaction();
      if (!empty($context_settings)) {
        $config = _multisite_twitterblock_load_twitter_config($context_settings['config']);
      }
      // Load default settings if no override.
      if (empty($config)) {
        $config = _multisite_twitterblock_load_twitter_config();
      }
      $block['subject'] = $config['title'];
      $block['content'] = theme('fpfis_twitter', $config);
      break;
      }
  }
  return $block;
}

/**
 * Loads twitter config.
 *
 * @param array $override
 *   array of new settings
 *
 * @return array
 *   twitter config
 */
function _multisite_twitterblock_load_twitter_config($override = NULL) {
  $defaults = array(
    'title' => variable_get('fpfis_twitter_title', '<none>'),
    'type' => variable_get('fpfis_twitter_type', 'smk-twitter_user_timeline'),
    'screen_name' => variable_get('fpfis_twitter_screen_name', MS_TWEETBLOCK_DEFAULT_SCREEN_NAME),
    'owner_screen_name' => variable_get('fpfis_twitter_owner_screen_name', MS_TWEETBLOCK_DEFAULT_OWNER_SCREEN_NAME),
    'slug' => variable_get('fpfis_twitter_slug', MS_TWEETBLOCK_DEFAULT_SLUG),
    'incl_hashtags' => variable_get('fpfis_twitter_incl_hashtags', MS_TWEETBLOCK_DEFAULT_INCL_HASHTAGS),
    'incl_profiles' => variable_get('fpfis_twitter_incl_profiles', MS_TWEETBLOCK_DEFAULT_INCL_PROFILES),
    'excl_hashtags' => variable_get('fpfis_twitter_excl_hashtags', MS_TWEETBLOCK_DEFAULT_EXCL_HASHTAGS),
    'excl_profiles' => variable_get('fpfis_twitter_excl_profiles', MS_TWEETBLOCK_DEFAULT_EXCL_PROFILES),
    'from' => variable_get('fpfis_twitter_from', MS_TWEETBLOCK_DEFAULT_FROM),
    'restr_lang_to' => variable_get('fpfis_twitter_restr_lang_to', MS_TWEETBLOCK_DEFAULT_RESTR_LANG_TO),
    'result_type' => variable_get('fpfis_twitter_result_type', MS_TWEETBLOCK_DEFAULT_RESULT_TYPE),
    'count' => variable_get('fpfis_twitter_count', MS_TWEETBLOCK_DEFAULT_COUNT),
    'include_rts' => variable_get('fpfis_twitter_include_rts', MS_TWEETBLOCK_DEFAULT_INCLUDE_RTS),
    'exclude_replies' => variable_get('fpfis_twitter_exclude_replies', MS_TWEETBLOCK_DEFAULT_EXCLUDE_REPLIES),
    'rts_display_original' => variable_get('fpfis_twitter_rts_display_original', MS_TWEETBLOCK_DEFAULT_RTS_DISPLAY_ORIGINAL),
    'display_user' => variable_get('fpfis_twitter_display_user', MS_TWEETBLOCK_DEFAULT_DISPLAY_USER),
    'display_user_pic' => variable_get('fpfis_twitter_display_user_pic', MS_TWEETBLOCK_DEFAULT_DISPLAY_USER_PIC),
    'auto_expand_photo' => variable_get('fpfis_twitter_auto_expand_photo', MS_TWEETBLOCK_DEFAULT_AUTO_EXPAND_PHOTO),
  );

  if ($override) {
    $overrdien_values['title'] = $override['title'];
    $overrdien_values['type']  = $override['type'];
    // Pop out type specific settings.
    $fpfis_twitter_types = variable_get('fpfis_twitter_types');
    foreach ($fpfis_twitter_types as $key => $current_type) {
      if (isset($override[$key])) {
        if (isset($override[$key]['detailed'])) {
          $overrdien_values = array_merge($override[$key]['detailed'], $overrdien_values);
          unset($override[$key]['detailed']);
        }
        $overrdien_values = array_merge($override[$key], $overrdien_values);
      }
    }

    $config = array_merge($defaults, $overrdien_values);
  }
  else {
    $config = $defaults;
  }

  return $config;
}

/**
 * Implements hook_theme().
 */
function multisite_twitterblock_theme() {
  return array(
    'fpfis_twitter' => array(
      'variables' => array('config' => NULL),
    ),
  );
}

/**
 * Implements theme hook.
 * @global bool $is_https
 *
 * @param array $variables
 *   array of new variables
 *
 * @return string
 *   twitter output config
 */
function theme_fpfis_twitter($variables) {
  global $is_https;
  drupal_add_js(($is_https ? 'https' : 'http') . '://ec.europa.eu/wel/social-media-kit/social-media-kit.js');
  $type = $variables['type'];
  unset($variables['title']);
  unset($variables['type']);
  switch ($type) {
    case 'smk-twitter_user_timeline':{
      // Remove List member feed specific settings.
      unset($variables['owner_screen_name']);
      unset($variables['slug']);
      // Remove Search feed specific settings.
      unset($variables['incl_hashtags']);
      unset($variables['incl_profiles']);
      unset($variables['excl_hashtags']);
      unset($variables['excl_profiles']);
      unset($variables['from']);
      unset($variables['restr_lang_to']);
      unset($variables['result_type']);
      break;
      }
    case 'smk-twitter_list_timeline':{
      // Remove User feed specific settings.
      unset($variables['screen_name']);
      // Remove Search feed specific settings.
      unset($variables['incl_hashtags']);
      unset($variables['incl_profiles']);
      unset($variables['excl_hashtags']);
      unset($variables['excl_profiles']);
      unset($variables['from']);
      unset($variables['restr_lang_to']);
      unset($variables['result_type']);
      break;
      }
    case 'smk-twitter_search':{
      // Remove User feed specific settings.
      unset($variables['screen_name']);
      // Remove List member feed specific settings.
      unset($variables['owner_screen_name']);
      unset($variables['slug']);
      break;
      }
  }

  $booleans = array(
    'include_rts',
    'rts_display_original',
    'display_user',
    'display_user_pic',
    'auto_expand_photo',
  );

  // Set boolean values to boolean for the js library.
  // Drupal checkbox uses integer 0 for false.
  foreach ($booleans as $key) {
    if (isset($variables[$key])) {
      $variables[$key] = (boolean) $variables[$key];
    }
  }
  $config = json_encode($variables);
  return '<div id="' . $type . '"><!--' . $config . '//--></div>';
}

/**
 * Implements hook_node_prepare().
 */
function multisite_twitterblock_node_prepare($node) {
  if (!multisite_twitterblock_twitter_override_type($node->type)) {
    return;
  }
  if (empty($node->fpfis_twitter_override)) {
    $fpfis_twitter_override = array();
    if (isset($node->nid)) {
      $item = multisite_twitterblock_load($node->nid, 'node');
      if ($item) {
        $fpfis_twitter_override['enabled'] = TRUE;
        $fpfis_twitter_override['config'] = _multisite_twitterblock_load_twitter_config(unserialize($item['data']));
      }
    }
  }

  if (empty($fpfis_twitter_override)) {
    // Set default values.
    $fpfis_twitter_override['config'] = _multisite_twitterblock_load_twitter_config(NULL);
    $fpfis_twitter_override['enabled'] = FALSE;
  }
  $node->fpfis_twitter_override = $fpfis_twitter_override;
}

/**
 * Implements hook_form_BASE_FORM_ID_alter().
 *
 * Adds toc fields to the node form.
 *
 * @see multisite_twitterblock_node_submit()
 */
function multisite_twitterblock_form_node_form_alter(&$form, $form_state) {
  $type = $form['#node']->type;
  if (!multisite_twitterblock_twitter_override_type($type)) {
    return;
  }
  $fpfis_twitter_override   = $form['#node']->fpfis_twitter_override;
  $form['fpfis_twitter_override'] = array(
    '#type' => 'fieldset',
    '#title' => t('Twitter settings'),
    '#access' => user_access('override fpfis twitter widget'),
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
    '#group' => 'additional_settings',
    '#tree' => TRUE,
    '#weight' => 2,
    '#attributes' => array('class' => array('fpfis_twitter_override-form')),
  );

  $form['fpfis_twitter_override']['enabled'] = array(
    '#type' => 'checkbox',
    '#title' => t('Override Twitter widget on this page'),
    '#default_value' => $fpfis_twitter_override['enabled'],
  );

  $form['fpfis_twitter_override']['config'] = _multisite_twitterblock_settings_form($form['#node']->fpfis_twitter_override['config'], 'override', '', "fpfis_twitter_override[config]");
  $form['fpfis_twitter_override']['config'] += array(
    '#type' => 'container',
    '#collapsible' => FALSE,
    '#collapsed' => FALSE,
    '#states' => array(
      'visible' => array(
        ':input[name="fpfis_twitter_override[enabled]"]' => array('checked' => TRUE),
      ),
    ),
  );
}

/**
 * Checks value in the types array.
 *
 * @param string $type
 *   type
 *
 * @return bool
 *   result of checking
 */
function multisite_twitterblock_twitter_override_type($type) {
  $options = array_values(variable_get('fpfis_twitter_override_types', array()));
  return in_array($type, $options, TRUE);
}

/**
 * Loads overriding config from db.
 *
 * @param int $entity_id
 *   Entity Id
 * @param string $entity_type
 *   Entity type
 *
 * @return bool
 *   result of request
 */
function multisite_twitterblock_load($entity_id, $entity_type = 'node') {
  if (is_numeric($entity_id)) {
    $query = db_select('multisite_twitterblock_twitter_overrides', 'tw');
    $query->fields('tw');
    $query->condition('tw.entity_id', $entity_id);
    $query->condition('tw.entity_type', $entity_type);
    if ($item = $query->execute()->fetchAssoc()) {
      return $item;
    }
  }
  return FALSE;
}

/**
 * Implements hook_node_insert().
 */
function multisite_twitterblock_node_insert($node) {
  multisite_twitterblock_node_save($node);
}

/**
 * Implements hook_node_update().
 */
function multisite_twitterblock_node_update($node) {
  multisite_twitterblock_node_save($node);
}

/**
 * Helper for hook_node_insert() and hook_node_update().
 */
function multisite_twitterblock_node_save($node) {
  if (isset($node->fpfis_twitter_override)) {
    $fpfis_twitter_override = &$node->fpfis_twitter_override;
    if (empty($fpfis_twitter_override['enabled'])) {
      // Remove previously created.
      if (multisite_twitterblock_load($node->nid, 'node')) {
        multisite_twitterblock_delete($node->nid, 'node');
      }
    }
    else {
      // Create new.
      $fpfis_twitter_override['nid'] = $node->nid;
      multisite_twitterblock_save($fpfis_twitter_override, 'node');
    }
  }
}

/**
 * Implements hook_node_delete().
 */
function multisite_twitterblock_node_delete($node) {
  multisite_twitterblock_delete($node->nid);
}

/**
 * Create Table of Contents for node.
 *
 * @param array $fpfis_twitter_override
 *   array
 * @param string $entity_type
 *   string
 */
function multisite_twitterblock_save($fpfis_twitter_override, $entity_type = 'node') {
  $status = db_merge('multisite_twitterblock_twitter_overrides')
  ->key(array('entity_id' => $fpfis_twitter_override['nid']))
  ->fields(array(
    'entity_type' => $entity_type,
    'data' => serialize($fpfis_twitter_override['config']),
  ))
  ->execute();
}

/**
 * Delete Table of Contents from node(s).
 *
 * @param int $entity_id
 *   Entity Id
 * @param string $entity_type
 *   Entity type
 */
function multisite_twitterblock_delete($entity_id, $entity_type = 'node') {
  $delete = db_delete('multisite_twitterblock_twitter_overrides')
  ->condition('entity_id', $entity_id, is_array($entity_id) ? 'IN' : '=')
  ->condition('entity_type', $entity_type, '=')
  ->execute();
}

/**
 * Defines form settings.
 *
 * @param array $default_values
 *   array of default values
 * @param string $mode
 *   mode
 * @param string $prefix
 *   prefix
 * @param string $container
 *   containter
 *
 * @return array
 *   array form
 */
function _multisite_twitterblock_settings_form($default_values, $mode = 'full', $prefix = 'fpfis_twitter_', $container = '') {
  $fpfis_twitter_types = variable_get('fpfis_twitter_types');

  $form[$prefix . 'title'] = array(
    '#type' => 'textfield',
    '#title' => t('Widget title'),
    '#default_value' => $default_values['title'],
    '#description' => t('Widget title is displayed abouve the twitter widget. Use &lt;none&gt; to leave it empty.'),
  );

  $form[$prefix . 'type'] = array(
    '#type' => 'select',
    '#title' => t('Widget type'),
    '#options' => $fpfis_twitter_types,
    '#default_value' => $default_values['type'],
    '#description' => t('User feed,  List member feed, Search'),
  );
  $visibility_selector = $container == '' ? ($prefix . 'type') : ($container . '[' . $prefix . 'type]');

  $form['smk-twitter_user_timeline'] = array(
    '#type' => 'container',
    '#title' => t('User feed settings'),
    '#collapsible' => FALSE,
    '#collapsed' => FALSE,
    '#states' => array(
      'visible' => array(
        ':input[name="' . $visibility_selector . '"]' => array('value' => 'smk-twitter_user_timeline'),
      ),
    ),
  );

  $form['smk-twitter_list_timeline'] = array(
    '#type' => 'container',
    '#title' => t('List member feed settings'),
    '#collapsible' => FALSE,
    '#collapsed' => FALSE,
    '#states' => array(
      'visible' => array(
        ':input[name="' . $visibility_selector . '"]' => array('value' => 'smk-twitter_list_timeline'),
      ),
    ),
  );

  $form['smk-twitter_search'] = array(
    '#type' => 'container',
    '#title' => t('Search feed settings'),
    '#collapsible' => FALSE,
    '#collapsed' => FALSE,
    '#states' => array(
      'visible' => array(
        ':input[name="' . $visibility_selector . '"]' => array('value' => 'smk-twitter_search'),
      ),
    ),
  );

  // User.
  $form['smk-twitter_user_timeline'][$prefix . 'screen_name'] = array(
    '#type' => 'textfield',
    '#title' => t('User screen name'),
    '#default_value' => $default_values['screen_name'],
    '#description' => t('User Twitter screen name'),
  );

  // List.
  $form['smk-twitter_list_timeline'][$prefix . 'owner_screen_name'] = array(
    '#type' => 'textfield',
    '#title' => t('List owner screen name'),
    '#default_value' => $default_values['owner_screen_name'],
    '#description' => t('Owner Twitter screen name'),
  );

  $form['smk-twitter_list_timeline'][$prefix . 'slug'] = array(
    '#type' => 'textfield',
    '#title' => t('Name of the list'),
    '#default_value' => $default_values['slug'],
    '#description' => t('Name of the list'),
  );

  $form['smk-twitter_search'][$prefix . 'incl_hashtags'] = array(
    '#type' => 'textfield',
    '#title' => t('Hashtags'),
    '#default_value' => $default_values['incl_hashtags'],
    '#description' => t('Comma seperated list of hashtags: search for tweets containing all specified hashtags'),
  );

  $form['smk-twitter_search'][$prefix . 'incl_profiles'] = array(
    '#type' => 'textfield',
    '#title' => t('Profiles'),
    '#default_value' => $default_values['incl_profiles'],
    '#description' => t('Comma seperated list of screen names: search for tweets containing all specified screen names'),
  );

  $form['smk-twitter_search']['detailed'] = array(
    '#type' => 'fieldset',
    '#title' => t('Detailed search settings'),
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
  );

  $form['smk-twitter_search']['detailed'][$prefix . 'excl_hashtags'] = array(
    '#type' => 'textfield',
    '#title' => t('Exclude hashtags'),
    '#default_value' => $default_values['excl_hashtags'],
    '#description' => t('Comma seperated list of hashtags: exclude tweets containing at least one specified hashtag'),
  );

  $form['smk-twitter_search']['detailed'][$prefix . 'excl_profiles'] = array(
    '#type' => 'textfield',
    '#title' => t('Exclude profiles'),
    '#default_value' => $default_values['excl_profiles'],
    '#description' => t('Comma seperated list of screen names: exclude tweets containing at least one specified screen name'),
  );

  $form['smk-twitter_search']['detailed'][$prefix . 'from'] = array(
    '#type' => 'textfield',
    '#title' => t('From'),
    '#default_value' => $default_values['from'],
    '#description' => t('Comma seperated list of screen names: display tweets from screen names'),
  );

  $form['smk-twitter_search']['detailed'][$prefix . 'restr_lang_to'] = array(
    '#type' => 'textfield',
    '#title' => t('Restrict language to'),
    '#default_value' => $default_values['restr_lang_to'],
    '#description' => t('Restricts tweets to the given language, given by an <a href="http://en.wikipedia.org/wiki/List_of_ISO_639-1_codes" target="_blank">ISO 639-1</a> code.'),
  );

  $form['smk-twitter_search']['detailed'][$prefix . 'result_type'] = array(
    '#type' => 'textfield',
    '#title' => t('Result type'),
    '#default_value' => $default_values['result_type'],
    '#description' => t('<ul><li>mixed: include both popular and real time results in the response</li><li>recent: return only the most recent results in the response</li><li>popular: return only the most popular results in the response</li></ul>'),
  );

  $form['advanced'] = array(
    '#type' => 'fieldset',
    '#title' => t('Advanced widget settings'),
    '#collapsible' => TRUE,
    '#collapsed' => FALSE,
  );

  $form['advanced']['notice'] = array(
    '#markup' => t('<p>For detailed information on the following settings please refer to the <a target="_blank" href="http://webtools.ec.europa.eu/social-media-kit/documentation/">Social Media Kit documentation</a>.</p>'),
  );

  $form['advanced'][$prefix . 'count'] = array(
    '#type' => 'textfield',
    '#title' => t('The number of tweets displayed'),
    '#default_value' => $default_values['count'],
    '#description' => t('(1-10)'),
  );

  $form['advanced'][$prefix . 'include_rts'] = array(
    '#type' => 'checkbox',
    '#title' => t('Display retweets'),
    '#default_value' => $default_values['include_rts'],
    '#return_value' => TRUE,
    '#description' => t('Display retweets'),
  );

  $form['advanced'][$prefix . 'exclude_replies'] = array(
    '#type' => 'checkbox',
    '#title' => t('Exclude replies'),
    '#default_value' => $default_values['exclude_replies'],
    '#return_value' => TRUE,
    '#description' => t('Exclude replies'),
  );

  $form['advanced'][$prefix . 'rts_display_original'] = array(
    '#type' => 'checkbox',
    '#title' => t('Display the original profile of a retweet'),
    '#default_value' => $default_values['rts_display_original'],
    '#return_value' => TRUE,
    '#description' => t('Display the original profile of a retweet'),
  );

  $form['advanced'][$prefix . 'display_user'] = array(
    '#type' => 'checkbox',
    '#title' => t('Display the user name'),
    '#default_value' => $default_values['display_user'],
    '#return_value' => TRUE,
    '#description' => t('Display the user name'),
  );

  $form['advanced'][$prefix . 'display_user_pic'] = array(
    '#type' => 'checkbox',
    '#title' => t('Display the user profile picture'),
    '#default_value' => $default_values['display_user_pic'],
    '#return_value' => TRUE,
    '#description' => t('Display the user profile picture'),
  );

  $form['advanced'][$prefix . 'auto_expand_photo'] = array(
    '#type' => 'checkbox',
    '#title' => t('Automatically expand an image in the tweet'),
    '#default_value' => $default_values['auto_expand_photo'],
    '#return_value' => TRUE,
    '#description' => t('Expand images inside the post'),
  );

  if ($mode == 'override') {
    unset($form['advanced']);
  }

  return $form;
}

/**
 * Implements hook_context_plugins().
 */
function multisite_twitterblock_context_plugins() {
  $plugins = array();
  $plugins['multisite_twitterblock_context_reaction'] = array(
    'handler' => array(
      'path' => drupal_get_path('module', 'multisite_twitterblock') . '/plugins',
      'file' => 'multisite_twitterblock_reaction.inc',
      'class' => 'SocialReaction',
      'parent' => 'context_reaction',
    ),
  );
  return $plugins;
}

/**
 * Implements hook_context_registry().
 */
function multisite_twitterblock_context_registry() {
  return array(
    'reactions' => array(
      'multisite_twitterblock' => array(
        'title' => t('Social Media Overrides'),
        'plugin' => 'multisite_twitterblock_context_reaction',
      ),
    ),
  );
}

/**
 * Implements hook_context_page_reaction().
 */
function multisite_twitterblock_context_page_reaction() {
  if ($plugin = context_get_plugin('reaction', 'multisite_twitterblock_context_reaction')) {
    $plugin->execute();
  }
}

/**
 * Detecs twitterblock context.
 * @return array
 *   array of reactions
 */
function multisite_twitterblock_detect_multisite_twitterblock_reaction() {
  $active_contexts = context_active_contexts();
  $reaction = array();

  foreach ($active_contexts as $active_context) {
    if (is_array($active_context->reactions) && count($active_context->reactions) > 0) {
      foreach ($active_context->reactions as $reaction_type => $current_reaction) {
        if ($reaction_type == 'multisite_twitterblock') {
          $reaction = $current_reaction;
        }
      }
    }
  }

  return $reaction;
}
