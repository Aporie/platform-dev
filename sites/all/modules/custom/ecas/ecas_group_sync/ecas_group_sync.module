<?php
/**
 * @file
 * Drupal needs this blank file.
 */

/**
 * hook_menu
 */
function ecas_group_sync_menu() {
  $items['admin/config/ecas/group_sync'] = array(
    'title' => 'Group sync settings',
    'description' => 'Configure group sync mapping',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ecas_group_sync_mapping_form'),
    'access arguments' => array('administer ecas'),
    'file' => 'ecas_group_sync.admin.inc',
    'type' => MENU_NORMAL_ITEM | MENU_LOCAL_TASK,
  );

  return $items;
}

/**
 * hook_info_ecas_update
 * implement mapping between LDAP data and user accounts
 */
function ecas_group_sync_info_ecas_update($user, $user_info, $args) {
  // mapping between DG and drupal roles
  if(isset($user_info['dg']))  {  // the user is affected to a DG
    $query = db_select('ecas_sync_mapping', 'esm'); // get mapping rules
    $query->condition('synctype', 'role','=');
    $query->condition('LDAPfield', 'dg','=');
    $query->condition('LDAPfield_value', $user_info['dg'], '=');
    $query->fields('esm');
    $query->join('role', 'r', 'esm.synctype_value = r.rid');
    $query->fields('r',array('name'));
    $results = $query->execute();
       
    $roles = $user->roles;            
    while($row = $results->fetchAssoc()) {
      $roles[$row['synctype_value']] = $row['name'];
    }
    $user->roles = $roles;
    user_save($user, array('roles' => $roles));    
  }
}
