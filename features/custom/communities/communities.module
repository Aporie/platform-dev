<?php
/**
 * @file
 * Code for the communities feature.
 */

include_once('communities.features.inc');


/*
* hook_disable
*/
function communities_disable() {
  _disable_content_type('community');
  
   // revoke permissions to roles ----------------------------------------------------------------------------------------------------------------------------------------------
  $result = db_select('role', 'r')
    ->condition('name', "contributor",'=')
    ->fields('r', array('rid'))
    ->execute()
    ->fetchAssoc();

  user_role_revoke_permissions($result['rid'], array(  
    'create community content',
	'delete own community content',
	'edit own community content',  
  ));  
}


/*
* hook_enable
*/
function communities_enable() {
  // create og role -------------------------------------------------------------------------------------------------------------------------------
  $community_manager_role = og_create_global_role("community_manager");
}



/*
* hook_views_pre_render
*/
function communities_views_pre_render(&$view) {
  if($view->name == 'communities_directory') {
    $alphabet = array('a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z');
    
    $output = '<div class="well btn-toolbar action_bar">';
    $output .= '<div class="btn-group">';
    
    foreach($alphabet as $letter) {
      $url = $_GET['q'].'/'.$letter;
      $output .= l($letter,$url,array('attributes' => array('class' => array('btn btn-small action-expand'))));
    }
    
    $output .= '</div>';
    
    if(user_access('create community content'))  {
      $output.= '<div class="btn-group">';
      $output.= l(t('create a new community'),'node/add/community',array('attributes' => array('class' => array('btn btn-info'))));
      $output.= '</div>';    
    }
    
    $output .= '</div>';
    
    $view->header['area']->options['content'] = $output;
  }
}



/*
* hook_init
*/
function communities_init() {
  drupal_add_css(drupal_get_path('module', 'communities') . '/communities.css');
}


/*
* hook_modules_enabled
*/
function communities_modules_enabled($modules) {
  if(in_array('communities', $modules)) { 
  }
}


/*
* hook_node_type_insert
*/
function communities_node_type_insert($info) {
  if($info->type == 'community') {
	node_types_rebuild();
	  
    // add permissions to roles ----------------------------------------------------------------------------------------------------------------------------------------------
    $au = db_select('role', 'r')
      ->condition('name', "authenticated user",'=')
      ->fields('r', array('rid'))
      ->execute()
      ->fetchAssoc();

    user_role_grant_permissions($au['rid'], array(  
      'create community content',
	  'delete own community content',
	  'edit own community content',
      'view own unpublished content',
	  'view revisions',
	  'access workbench',
      'use workbench_moderation my drafts tab',
      'use workbench_moderation needs review tab',
      'view moderation messages', 
    )); 	
  
    // add permissions to OG roles ----------------------------------------------------------------------------------------------------------------------------------------------  
    $cm = db_select('og_role', 'r')
      ->condition('name', "community_manager",'=')
      ->fields('r', array('rid'))
      ->execute()
      ->fetchAssoc();  
  
    og_role_grant_permissions($cm['rid'], array(  
      'add user',
      'approve and deny subscription',
      'unsubscribe',
      'update group', 
      'administer group',
    ));  
  }	
}

