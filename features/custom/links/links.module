<?php
/**
 * @file
 * Code for the Links feature.
 */

include_once('links.features.inc');

/*
 * Hook enable 
 * Edit communities context to add a block
 */
function links_enable(){

  //Add block in context
  _add_block_context('communities','links-block','views','links-block', 'sidebar_first');
  
  drupal_set_message('Links feature is now active on your site.');

}


/*
 * Hook disable 
 * Edit communities context to remove block
 * Remove permissions
 */
function links_disable(){

  // Remove block
  _remove_block_context('communities', 'links-block');

  /*** Remove permissions ***/
  _disable_content_type('links');
  
  // Administrator
  $adm = db_select('role', 'r')
    ->condition('name', "administrator",'=')
    ->fields('r', array('rid'))
    ->execute()
    ->fetchAssoc();

  user_role_revoke_permissions($adm['rid'], array(
    'edit own links content',
    'edit any links content',
    'delete own links content',
    'delete any links content',
    'create links content',
  ));
    
  // Contributor
  $contrib = db_select('role', 'r')
    ->condition('name', "contributor",'=')
    ->fields('r', array('rid'))
    ->execute()
    ->fetchAssoc();
      
  user_role_revoke_permissions($contrib['rid'], array(
    'edit own links content',
    'edit any links content',
    'delete own links content',
    'delete any links content',
    'create links content',
  ));
          
  // Disable permissions to OG roles ---------------------------------------------------------------  
  // Community Manager
  $cm = db_select('og_role', 'r')
    ->condition('name', "community_manager",'=')
    ->fields('r', array('rid'))
    ->execute()
    ->fetchAssoc();

  og_role_revoke_permissions($cm['rid'], array(
    'update own links content',
    'update any links content',
    'delete own links content',
    'delete any links content',
  ));
    
  // Administrator Member
  $admm = db_select('og_role', 'r')
    ->condition('name', "administrator member",'=')
    ->fields('r', array('rid'))
    ->execute()
    ->fetchAssoc();

  og_role_revoke_permissions($admm['rid'], array(
    'update own links content',
    'update any links content',
    'delete own links content',
    'delete any links content',
  ));
    
  drupal_flush_all_caches(); 
  drupal_set_message('Links feature is now disabled on your site.');
}


/*
* hook_node_insert
*/

function links_node_insert($node) {
  if ($node->type == 'links') {
    node_types_rebuild();

    drupal_set_message("invalide cache og");
    og_invalidate_cache();
    
    // Add permissions to roles ----------------------------------------------------------------------------------------------------------------------------------------------
    // Administrator
    $adm = db_select('role', 'r')
      ->condition('name', "administrator",'=')
      ->fields('r', array('rid'))
      ->execute()
      ->fetchAssoc();

    user_role_grant_permissions($adm['rid'], array(  
      'edit own links content',
      'edit any links content',
      'delete own links content',
      'delete any links content',
      'create links content',
    ));
    
    // Contributor
    $contrib = db_select('role', 'r')
      ->condition('name', "contributor",'=')
      ->fields('r', array('rid'))
      ->execute()
      ->fetchAssoc();
      
    user_role_grant_permissions($contrib['rid'], array(
      'edit own links content',
      'edit any links content',
      'delete own links content',
      'delete any links content',
      'create links content',
    ));
          
  // Add permissions to OG roles ---------------------------------------------------------------  
  // Community Manager
  $cm = db_select('og_role', 'r')
    ->condition('name', "community_manager",'=')
    ->fields('r', array('rid'))
    ->execute()
    ->fetchAssoc();

  og_role_grant_permissions($cm['rid'], array(
    'update own links content',
    'update any links content',
    'delete own links content',
    'delete any links content',
  ));
    
  // Administrator Member
  $admm = db_select('og_role', 'r')
    ->condition('name', "administrator member",'=')
    ->fields('r', array('rid'))
    ->execute()
    ->fetchAssoc();

  og_role_grant_permissions($admm['rid'], array(
    'update own links content',
    'update any links content',
    'delete own links content',
    'delete any links content',
  ));
    
  }
}

