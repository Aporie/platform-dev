<?php
/**
 * @file
 * Code for the nexteuropa Newsroom feature.
 */

include_once dirname(__FILE__) . '/nexteuropa_newsroom.features.field_base.inc';
include_once dirname(__FILE__) . '/nexteuropa_newsroom.features.inc';
include_once dirname(__FILE__) . '/nexteuropa_newsroom.multilingual.inc';
include_once dirname(__FILE__) . '/nexteuropa_newsroom.forms.inc';
include_once drupal_get_path('module', 'pathauto') . '/pathauto.inc';

define('NEWSROOM_TYPE_VOCABULARY', 'newsroom_item_type');
define('NEWSROOM_TOPIC_VOCABULARY', 'newsroom_topic');
define('NEWSROOM_SERVICE_VOCABULARY', 'newsroom_service');
define('NEWSROOM_TOPIC_OPERATOR_OR', 'OR');
define('NEWSROOM_CALENDAR_BLOCK', 'calendar');
define('NEWSROOM_URL', 'http://ec.europa.eu/information_society/newsroom/cf/');
define('NEWSROOM_PROPOSAL_ACCESS', 'send newsroom item proposal');
define('NEWSROOM_IMPORT_ACCESS', 'import newsroom feeds');
define('NEWSROOM_EDIT_ACCESS', 'edit remote newsroom item');
define('NEWSROOM_CLICKTHROUGH_FORCE', 'force');
define('NEWSROOM_ITEM_SEGMENT', 'fullrss-multilingual.cfm?item_id=');
define('NEWSROOM_TOPIC_SEGMENT', 'rss-service-multilingual.cfm?topic_id=');
define('NEWSROOM_SERVICE_SEGMENT', 'rss-service-multilingual.cfm?service_id=');
define('NEWSROOM_TYPE_SEGMENT', 'rss-item-type-multilingual.cfm?item_type_id=');
define('NEWSROOM_TOPIC_IMPORTER', 'newsroom_topics_multilingual');
define('NEWSROOM_SERVICE_IMPORTER', 'newsroom_services_multilingual');
define('NEWSROOM_TYPE_IMPORTER', 'newsroom_types_multilingual');
define('NEWSROOM_ITEM_IMPORTER', 'newsroom_items_multilingual');

global $_newsroom_universe_url;

/**
 * Implements hook_init().
 */
function nexteuropa_newsroom_init() {
  cache_clear_all('plugins:feeds:plugins', 'cache');
  global $_newsroom_universe_url;
  $universe_id = variable_get('newsroom_universe_id', FALSE);
  if ($universe_id) {
    $_newsroom_universe_url = _nexteuropa_newsroom_get_universe_url($universe_id);
  }
  // We show message in the admin part and for users who has access
  // to site configuration.
  if (arg(0) == 'admin' && user_access('administer site configuration')) {
    if (empty($universe_id)) {
      $newsroom_config_path = filter_xss(url('admin/config/content/newsroom'));
      drupal_set_message(t('The Newsroom feature needs to be configured before use. Please visit the <a href="!link">configuration page</a>!', array('!link' => $newsroom_config_path)), 'warning', FALSE);
    }
  }
}

/**
 * Implements hook_menu().
 */
function nexteuropa_newsroom_menu() {
  // Configuration page.
  $items['admin/config/content/newsroom'] = array(
    'title' => 'Newsroom',
    'description' => 'Configure Newsroom settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('nexteuropa_newsroom_admin_settings'),
    'access arguments' => array('administer newsroom settings'),
    'file' => 'nexteuropa_newsroom.admin.inc',
  );
  
  $items['news-redirect'] = array(
    'title' => 'Newsroom Item Redirect',
    'page callback' => '_nexteuropa_newsroom_item_redirect',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  $items['news-topic-redirect'] = array(
    'title' => 'Newsroom Item Topic Redirect',
    'page callback' => '_nexteuropa_newsroom_topic_redirect',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  $items['news-type-redirect'] = array(
    'title' => 'Newsroom Item Type Redirect',
    'page callback' => '_nexteuropa_newsroom_type_redirect',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  $items['news-service-redirect'] = array(
    'title' => 'Newsroom Item Service Redirect',
    'page callback' => '_nexteuropa_newsroom_service_redirect',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  $items['news-import'] = array(
    'title' => 'Newsroom Item Import',
    'page callback' => '_nexteuropa_newsroom_item_import',
    'access callback' => '_nexteuropa_nexteuropa_newsroom_item_import_access',
    'type' => MENU_CALLBACK,
  );
  $items['news-topic-import'] = array(
    'title' => 'Newsroom Topic Import',
    'page callback' => '_nexteuropa_newsroom_topic_import',
    'access callback' => '_nexteuropa_nexteuropa_newsroom_item_import_access',
    'type' => MENU_CALLBACK,
  );
  $items['news-type-import'] = array(
    'title' => 'Newsroom Type Import',
    'page callback' => '_nexteuropa_newsroom_type_import',
    'access callback' => '_nexteuropa_nexteuropa_newsroom_item_import_access',
    'type' => MENU_CALLBACK,
  );
  $items['news-service-import'] = array(
    'title' => 'Newsroom Service Import',
    'page callback' => '_nexteuropa_newsroom_service_import',
    'access callback' => '_nexteuropa_nexteuropa_newsroom_item_import_access',
    'type' => MENU_CALLBACK,
  );
  $items['news-delete'] = array(
    'title' => 'Newsroom Item Delete',
    'page callback' => '_nexteuropa_newsroom_item_delete',
    'access callback' => '_nexteuropa_nexteuropa_newsroom_item_import_access',
    'type' => MENU_CALLBACK,
  );
  $items['news-topic-delete'] = array(
    'title' => 'Newsroom Topic Delete',
    'page callback' => '_nexteuropa_newsroom_topic_delete',
    'access callback' => '_nexteuropa_nexteuropa_newsroom_item_import_access',
    'type' => MENU_CALLBACK,
  );
  $items['news-type-delete'] = array(
    'title' => 'Newsroom Type Delete',
    'page callback' => '_nexteuropa_newsroom_type_delete',
    'access callback' => '_nexteuropa_nexteuropa_newsroom_item_import_access',
    'type' => MENU_CALLBACK,
  );
  $items['news-service-delete'] = array(
    'title' => 'Newsroom Service Delete',
    'page callback' => '_nexteuropa_newsroom_service_delete',
    'access callback' => '_nexteuropa_nexteuropa_newsroom_item_import_access',
    'type' => MENU_CALLBACK,
  );
  $items['news-dispatcher'] = array(
    'title' => 'Newsroom Item Redirect',
    'page callback' => '_nexteuropa_newsroom_redirect',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  $items['news-proposal'] = array(
    'title' => 'Newsroom item proposal',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('nexteuropa_newsroom_newsroom_proposal_form'),
    'access arguments' => array(NEWSROOM_PROPOSAL_ACCESS),
  );

  return $items;
}

/**
 * Implements hook_help().
 */
function nexteuropa_newsroom_help($path, $arg) {
  $help = '';
  switch ($path) {
    // Help text for the newsroom feature.
    case 'admin/help#nexteuropa_newsroom':
      $help = '<p>' . t('The nexteuropa newsroom feature is meant to integrate the newsroom corporate service into a Drupal nexteuropa/Next Europa client. By enabling it you will have the chance to fetch contents from the newsroom service basing on the configuraiton of your "universe" into your instance of the newsroom. To configure the newsroom you will need to get an "Universe id" from the service provider, you will have this code once your universe has been fully configured as a service and it will be ready to serve you contents. In the newsroom <a href="@newsroom" title="newsroom configuraiton">admin settings page</a> you can then define many of the newsroom behaviours and you can start palying associating you existing content types with the newly imported news coming from the newsroom.', array('@newsroom' => url('admin/config/content/newsroom'))) . '</p>';

      break;

  }

  return $help;
}

/**
 * Implements hook_permission().
 */
function nexteuropa_newsroom_permission() {
  return array(
    'administer newsroom settings' => array(
      'title' => t('Administer Newsroom settings'),
    ),
    'administer newsroom advanced settings' => array(
      'title' => t('Administer all the newsroom settings'),
    ),
    NEWSROOM_IMPORT_ACCESS => array(
      'title' => t('Import Newsroom feeds'),
    ),
    NEWSROOM_EDIT_ACCESS => array(
      'title' => t('Edit newsroom item in Newsroom'),
    ),
    NEWSROOM_PROPOSAL_ACCESS => array(
      'title' => t('Send newsroom item proposal'),
    ),
  );
}

/**
 * Sets feature set api version.
 *
 * @return array
 *   version number
 */
function nexteuropa_newsroom_feature_set_api() {
  return array('version' => '1.0');
}

/**
 * Implements hook_image_default_styles().
 */
function nexteuropa_newsroom_image_default_styles() {
  // Exported image style: newsroom_style.
  $styles['newsroom_style'] = array(
    'name' => 'newsroom_style',
    'label' => 'newsroom_style',
    'effects' => array(
      1 => array(
        'label' => 'Scale',
        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
        'effect callback' => 'image_scale_effect',
        'dimensions callback' => 'image_scale_dimensions',
        'form callback' => 'image_scale_form',
        'summary theme' => 'image_scale_summary',
        'module' => 'image',
        'name' => 'image_scale',
        'data' => array(
          'width' => 250,
          'height' => '',
          'upscale' => 1,
        ),
        'weight' => 1,
      ),
    ),
  );

  return $styles;
}

/**
 * Implements hook_post_features_enable_feature().
 */
function nexteuropa_newsroom_post_features_enable_feature($component) {
  switch ($component) {
    case 'field_base':
      // Revert the field component,it seems it is not ready after it's enabled.
      features_revert(array('nexteuropa_newsroom' => array($component)));
      break;

    case 'taxonomy':
      // Set translation mode for the vocabularies.
      $importer_id = array(
        'topics' => NEWSROOM_TOPIC_VOCABULARY,
        'services' => NEWSROOM_SERVICE_VOCABULARY,
        'types' => NEWSROOM_TYPE_VOCABULARY,
      );

      foreach ($importer_id as $key => $importer) {
        title_field_replacement_toggle('taxonomy_term', $importer, 'name');
        call_user_func('_nexteuropa_newsroom_create_multilingual_' . $key . '_importer');
      }

      cache_clear_all('plugins:feeds:plugins', 'cache');
      break;

    case 'node':
      // No way to generate the node importer without this.
      drupal_static_reset();
      drupal_flush_all_caches();
      // Enable title replacement for the newsroom_item content type.
      title_field_replacement_toggle('node', 'newsroom_item', 'title');

      $importer_id = array(
        'items' => 'newsroom_items',
      );
      // Create the dynamic node importer and disable the static ones.
      foreach ($importer_id as $key => $importer) {
        call_user_func('_nexteuropa_newsroom_create_multilingual_' . $key . '_importer');
      }

      cache_clear_all('plugins:feeds:plugins', 'cache');
      break;
  }
}

/**
 * Helper function to check if the universe ID has been already set.
 */
function _nexteuropa_newsroom_check_universe_id() {
  // After initital setup disable Universe ID field.
  $universe_id = array();
  $nri = variable_get('newsroom_universe_id', NULL);
  if (!empty($nri)) {
    $universe_id['disabled'] = TRUE;
    $universe_id['description'] = t('To change the Newsroom Universe ID contact the site administrator.');
    $universe_id['class'] = 'selected';
    $universe_id['collapsing'] = FALSE;
  }
  else {
    $universe_id['disabled'] = FALSE;
    $universe_id['description'] = t('After setting the Newsroom Universe ID for the first time content will be imported from the Newsroom service. This might take a few minutes.');
    $universe_id['class'] = 'not-selected';
    $universe_id['collapsing'] = TRUE;
  }
  return $universe_id;
}

/**
 * Prepare options for the content type select.
 *
 * @param string $type
 *   Type of the options to generate.
 *
 * @return array
 *   Array of options.
 */
function _nexteuropa_newsroom_prepare_options($type) {
  $options = array();
  if (is_numeric($type)) {
    for ($i = 1; $i <= $type; $i++) {
      $options[$i] = $i;
    }
  }
  else {
    // Get a list of the existing content type.
    $content_types = node_type_get_types();
    // Exclude the ct used for the import.
    unset($content_types['newsroom_item']);
    unset($content_types['newsroom_selection']);
    // Build options for selecting content types.
    foreach ($content_types as $name => $content_type) {
      if ($content_type->disabled !== 1) {
        $options[$name] = $content_type->name;
      }
    }
  }
  return $options;
}

/**
 * Add fields to selected content types.
 *
 * @param string $type
 *   Select or topic fo the moment.
 * @param array $sel_ct
 *   Array of content types machine names.
 */
function _nexteuropa_newsroom_add_fields($type = 'topic', $sel_ct = array()) {
  $field_name = 'field_associated_newsroom_' . $type;

  if (!empty($sel_ct)) {
    foreach ($sel_ct as $machine_name => $content_type) {
      $exist = field_info_instance('node', $field_name, $machine_name);
      // Check for existing instances.
      if ($exist === NULL) {
        $instance = array(
          'field_name' => $field_name,
          'entity_type' => 'node',
          'bundle' => $machine_name,
          'label' => 'Newsroom ' . $type,
          'description' => '',
          'required' => 0,
        );
        field_create_instance($instance);
        // Call the field_group helper function, we surely have to update it.
        _nexteuropa_newsroom_field_group($machine_name, $field_name);
        // Set a message to inform the user about the field instance creation.
        drupal_set_message(t('Created instance of @field in the @bundle content type', array('@field' => $field_name, '@bundle' => $machine_name)));
      }
    }
  }
}

/**
 * Remove all the instances of a fields.
 *
 * @param string $type
 *   Select or topic fo the moment.
 * @param array $sel_ct
 *   Array of content types machine names.
 */
function _nexteuropa_newsroom_remove_fields($type = 'topic', $sel_ct = array()) {
  // This function runs after checking for existing field values in the databas.
  $field_name = 'field_associated_newsroom_' . $type;
  // All is the parameter we get when an user want to delete all the instances.
  if ($sel_ct == 'all') {
    $instances = _nexteuropa_newsroom_get_instances($type);
  }
  // Limit the search to the selected content types.
  elseif (!empty($sel_ct)) {
    foreach ($sel_ct as $content_type) {
      $instances[] = $content_type;
    }
  }

  if (!empty($instances)) {
    // Loop through the instances to delete them.
    foreach ($instances as $instance) {
      $instance = field_info_instance('node', $field_name, $instance);
      field_delete_instance($instance, FALSE);
      // Call the field_group helper function, we could have to delete it.
      _nexteuropa_newsroom_field_group($instance['bundle'], $field_name);
      // Add the message to queue.
      drupal_set_message(t('Deleted instance of @field in the @bundle content type', array('@field' => $field_name, '@bundle' => $instance['bundle'])));
    }
  }
}

/**
 * Get the existing instances of fields.
 *
 * @param string $type
 *   Select or topic for the moment.
 *
 * @return array
 *   instances
 */
function _nexteuropa_newsroom_get_instances($type) {
  // Get instances per field.
  $instances = array();
  if ($type) {
    $content_types = node_type_get_types();
    $field_name = 'field_associated_newsroom_' . $type;
    $instances = array();
    // We loop through the list of content types to find all the instances.
    foreach ($content_types as $machine_name => $content_type) {
      $exist = field_info_instance('node', $field_name, $machine_name);
      if ($exist !== NULL) {
        $instances[] = $exist['bundle'];
      }
    }
  }
  return $instances;
}

/**
 * Check if it safe to delete field instances.
 *
 * @param string $type
 *   Select or topic fo the moment.
 * @param array $checks
 *   Array of items to check.
 *
 * @return array
 *   Information about the field name and nodes found.
 */
function _nexteuropa_newsroom_check_deletion($type, $checks = array()) {
  $nodes = array();
  // "All" is the parameter we get to delete all the instances.
  if ($checks == 'all') {
    $instances = _nexteuropa_newsroom_get_instances($type);
  }
  else {
    if (!empty($checks)) {
      // Get the instances to check for.
      foreach ($checks as $field => $check) {
        $instances[] = $check;
      }
    }
  }

  if (!empty($instances)) {
    foreach ($instances as $instance) {
      // Check in the database for values of the selected field.
      $query = db_select('field_data_field_associated_newsroom_' . $type, 'ch');
      $query->condition('bundle', $instance, '=');
      $num_rows = $query->countQuery()->execute()->fetchField();
      // There are values, we store the number of nodes to show it to the user.
      if ($num_rows > 0) {
        $nodes['field_data_field_associated_newsroom_' . $type][] = array(
          'ct' => $instance,
          'nodes' => $num_rows,
        );
      }
    }
  }
  return $nodes;
}

/**
 * Prepare check for instances deletion.
 *
 * @param array $previous
 *   Old values.
 * @param array $input
 *   New values.
 *
 * @return array
 *   Variables to pass.
 */
function _nexteuropa_newsroom_prepare_check(array $previous, array $input) {
  // Set some values.
  $selected['topic'] = array_filter($input['newsroom_content_types_topic']);
  $selected['select'] = array_filter($input['newsroom_content_types_select']);
  $check_topic = array();
  $check_select = array();
  // Check the two array for differences. we need to catch also a deselection.
  if ($selected != $previous) {
    $check_topic[] = array_diff($previous['topic'], $selected['topic']);
    $check_topic[] = array_diff($selected['topic'], $previous['topic']);
    $check_select[] = array_diff($previous['select'], $selected['select']);
    $check_select[] = array_diff($selected['select'], $previous['select']);
  }
  // Prepare all the relevant data formatted into an array().
  $infos = array(
    'selected' => array(
      'topic' => $selected['topic'],
      'select' => $selected['select'],
    ),
    'delete' => array(
      'topic' => $input['newsroom_content_types_delete_topic'],
      'select' => $input['newsroom_content_types_delete_select'],
    ),
    'check' => array(
      'topic' => $check_topic,
      'select' => $check_select,
    ),
  );

  return $infos;
}

/**
 * Create a field_group to hold the newsroom fields in a vertical tab.
 *
 * @param string $machine_name
 *   Content type machine name.
 * @param string $field_name
 *   Field machine name.
 */
function _nexteuropa_newsroom_field_group($machine_name, $field_name) {
  // Get info about the group, it's likely to be already in the database.
  $groups = field_group_info_groups('node', $machine_name, 'form', TRUE);
  $fields = array('topic', 'select');
  $group_name = 'group_' . $machine_name . '_newsroom';
  $instances = FALSE;
  // Check for instances of the newsroom fields inside the given content type.
  foreach ($fields as $field) {
    $field_name = 'field_associated_newsroom_' . $field;
    if (field_info_instance('node', $field_name, $machine_name) != NULL) {
      $instances[] = field_info_instance('node', $field_name, $machine_name);
    }
  }
  // If the group is already there, remove it.
  if (isset($groups[$group_name])) {
    db_delete('field_group')
      ->condition('bundle', $machine_name, '=')
      ->condition('group_name', 'group_' . $machine_name . '_newsroom', '=')
      ->execute();
  }
  // Create the group with the right children.
  if ($instances) {
    $field_group = (object) array(
      'identifier' => $group_name . '|node|' . $machine_name . '|form',
      'group_name' => $group_name,
      'entity_type' => 'node',
      'bundle' => $machine_name,
      'mode' => 'form',
      'children' => array(),
      'parent_name' => '',
      'weight' => 5,
      'label' => 'Newsroom fields',
      'format_type' => 'tab',
      'disabled' => FALSE,
      'format_settings' => array(
        'instance_settings' => array(
          'required_fields' => 0,
          'classes' => 'group-newsroom field-group-tab',
          'description' => '',
        ),
        'formatter' => 'closed',
      ),
    );

    foreach ($instances as $instance) {
      $field_group->children[] = $instance['field_name'];
    }

    field_group_group_save($field_group);
  }
  // Remove the group since we don't have fields to show.
  else {
    drupal_set_message(t('Removed the fieldgroup @name from the @content_type content type', array('@name' => $group_name, '@content_type' => $machine_name)), 'status');
  }
}

/**
 * The batch operation.
 *
 * @param array $chunk
 *   The terms to be updated.
 * @param string $voc
 *   Vocabulary's machine name.
 * @param array $operation_details
 *   Array of values.
 */
function nexteuropa_newsroom_restore_batch(array $chunk, $voc, array $operation_details) {

  foreach ($chunk as $id => $fields) {
    // Try to find the corresponding term basing on its ID.
    $term = _nexteuropa_newsroom_get_term_from_id($id, $voc);
    if ($term) {
      // Let's work with an array.
      $term = get_object_vars($term);

      // This is special, make them handable!.
      $special = array(
        'field_newsroom_field_featured_item',
      );

      if (!empty($fields)) {
        // Override values.
        foreach ($fields as $field_name => $value) {
          if (!in_array($propname, $special)) {
            $term[$field_name]['und'][0]['value'] = $value;
          }
          else {
            if (is_numeric($value)) {
              $term[$field_name]['und'][0]['target_id'] = $value;
            }
            else {
              unset($term[$field_name]['und'][0]);
            }
          }
        }

        if (isset($context)) {
          // Build the worked term name list.
          $context['results'][] .= $conf['name'] . ', ';
          $context['message'] = t('Restoring "@title" @operations', array('@title' => $term['name'], '@operations' => $operation_details));
        }
      }
      // Save the term with the new values.
      taxonomy_term_save((object) $term);
    }
  }
}

/**
 * Submit handler.
 */
function nexteuropa_newsroom_backup_conf_all($form, &$form_state) {
  $voc = $form['#vocabulary']->machine_name;
  // We need the whole tree here.
  $tree = taxonomy_get_tree($form['#vocabulary']->vid);

  foreach ($tree as $base_term) {
    $tid = $base_term->tid;
    $term = taxonomy_term_load($tid);
    $id = _nexteuropa_newsroom_get_ids($voc, (array) $term);

    // Working with arrays.
    $term = _nexteuropa_newsroom_export_prepare_values($term);
    $term = reset($term);
    $values[$id] = $term;
  }

  // Save the variable.
  variable_set($voc . '_backup', $values);

  // Set a message to the user.
  drupal_set_message(t('We saved a backup of your configuration for the vocabulary: "@name". if you need to restore the values in the backup click on the "Restore" button', array('@name' => $voc)), 'status');
}

/**
 * Get newsroom id values.
 */
function _nexteuropa_newsroom_get_ids($voc, $data) {
  switch ($voc) {
    case NEWSROOM_TYPE_VOCABULARY:
      $id = $data['field_newsroom_type_id']['und'][0]['value'];
      break;

    case NEWSROOM_SERVICE_VOCABULARY:
      $id = $data['field_newsroom_service_id']['und'][0]['value'];
      break;

    case NEWSROOM_TOPIC_VOCABULARY:
      $id = $data['field_newsroom_topic_id']['und'][0]['value'];
      break;
  }
  return $id;
}

/**
 * Grab the newsroom fields from a term.
 *
 * @param object $term
 *   The term to get the values from.
 *
 * @return array
 *   Formatted values for the newsroom related fields.
 */
function _nexteuropa_newsroom_export_prepare_values($term) {
  $term = get_object_vars($term);
  $voc = $term['vocabulary_machine_name'];
  $id = _nexteuropa_newsroom_get_ids($voc, $term);
  $values = array();
  $values[$id] = array();
  $voc = str_replace('_item', '', $voc);
  foreach ($term as $propname => $prop) {
    // Should work only with custom fields.
    if (strpos($propname, 'field') === 0) {
      if ($propname == 'field_' . $voc . '_id') {
        continue;
      }

      if (isset($prop['und'][0]['value'])) {
        $values[$id][$propname] = $prop['und'][0]['value'];
      }
    }
  }

  return $values;
}

/**
 * Find a term basing on its newsroom id.
 *
 * @param string $id
 *   The id coming from the newsroom.
 * @param string $voc
 *   Vocabulay's machine name.
 *
 * @return object
 *   The term object.
 */
function _nexteuropa_newsroom_get_term_from_id($id, $voc) {
  $field = str_replace('_item', '', $voc);
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'taxonomy_term')
    ->entityCondition('bundle', $voc)
    ->fieldCondition('field_' . $field . '_id', 'value', $id, '=');

  $results = $query->execute();

  if (!empty($results)) {
    $result = reset($results['taxonomy_term']);
    $tid = $result->tid;
    $term = taxonomy_term_load($tid);
  }
  else {
    $term = FALSE;
  }
  return $term;
}

/**
 * Helper function to get the enabled languages.
 */
function _nexteuropa_newsroom_languages() {
  $lang = locale_language_list('name');
  $lang_keys = array_keys($lang);
  $eng = array_search('en', $lang_keys);
  if ($eng) {
    unset($lang_keys[$eng]);
    array_unshift($lang_keys, 'en');
  }

  return $lang_keys;
}

/**
 * Helper function to enable translations for specific fields.
 */
function _nexteuropa_newsroom_enable_translations() {
  // Enable entity translation support for terms.
  $enabled = variable_get('entity_translation_entity_types', array());
  $enabled_types = array_filter($enabled);
  if (!in_array('taxonomy_term', $enabled_types)) {
    $enabled['taxonomy_term'] = 'taxonomy_term';
  }
  if (!in_array('file', $enabled_types)) {
    $enabled['file'] = 'file';
  }
  variable_set('entity_translation_entity_types', $enabled);

  // Enable translations for various fields.
  $field_names = array(
    'body',
    'field_file_image_alt_text',
    'field_file_image_title_text',
    'field_caption',
  );

  foreach ($field_names as $field_name) {
    $field = field_read_field($field_name);
    if ($field) {
      // Make the field translatable.
      $field['translatable'] = 1;
      field_update_field($field);
    }
  }
}

/**
 * Helper function to enable languages.
 */
function _nexteuropa_newsroom_enable_languages($languages) {
  if (module_exists('locale')) {
    include_once DRUPAL_ROOT . '/includes/locale.inc';
    foreach ($languages as $lang) {
      // Enabling languages.
      locale_add_language($lang);
    }
  }
}

/**
 * Helper prepares the tamper settings.
 *
 * @param string $settings
 *   Tamper settings.
 * @param int $i
 *   The order in the parser.
 * @param string $type
 *   Taxonomy or node.
 *
 * @return array
 *   Tamper settings.
 */
function _nexteuropa_newsroom_prepare_dynamic_tamper($settings, $i, $type = NULL) {
  $str = 'xpathparser_' . $i;
  $tamper = array(
    'id' => $type . '-' . $str . '-' . $settings['plugin_id'],
    'importer' => $type,
    'source' => 'xpathparser:' . $i,
    'plugin_id' => $settings['plugin_id'],
  );

  // Prepare setting for Entity Field Query finder.
  if ($settings['plugin_id'] == 'efq_finder') {
    $tamper += array(
      'settings' => array(
        'entity_type' => 'taxonomy_term',
        'bundle' => $settings['vocabulary'],
        'column' => 'value',
        'property' => FALSE,
        'update' => 'Update',
        'field' => $settings['field'],
      ),
      'description' => 'Entity Field Query finder',
    );
  }

  // Prepare setting for Rewrite plugin.
  if ($settings['plugin_id'] == 'rewrite') {
    $str = 'xpathparser_' . $i;
    $tamper += array(
      'settings' => array(
        'text' => $settings['prefix'] . '[xpathparser:' . $i . ']',
      ),
      'description' => 'Rewrite',
    );
  }
  return $tamper;
}

/**
 * Helper function to enable languages.
 *
 * @param array $premapping
 *   The values to elaborate.
 * @param string $type
 *   Taxonomy or node.
 *
 * @return array
 *   Array containing the needed info for the importer.
 */
function _nexteuropa_newsroom_prepare_dynamic_mapping(array $premapping, $type = NULL) {
  $def_lang = drupal_strtoupper(language_default()->language);
  // Get enabled languages codes.
  $lang_keys = _nexteuropa_newsroom_languages();
  // Loop through all the fields, build the needed arrays.
  $i = 0;

  foreach ($premapping as $field => $values) {
    if (isset($values['tamper'])) {
      $tamper = _nexteuropa_newsroom_prepare_dynamic_tamper($values['tamper'], $i, $type);
      _nexteuropa_newsroom_dynamic_tamper($tamper);
    }

    // Things look different if the field is translatable.
    if ($values['language']) {
      // If fields are translatable,
      // we create a different mapping for each language.
      foreach ($lang_keys as $lang_key) {
        $upper_key = drupal_strtoupper($lang_key);
        // Xpath queries.
        $queries['xpathparser:' . $i] = $values['query'] . '[@lang="' . $upper_key . '"]/text()';

        if (strpos($type, 'topic') && $upper_key != $def_lang) {
          $queries['xpathparser:' . $i] = '//channel/item[infsonewsroom:BasicSvType="Newsroom service"]/category[@domain!="Newsletter" and @lang="' . $upper_key . '" and @infsonewsroom:TopicId="$Temporary target 1"]/' . $values['query'];
        }
        elseif (strpos($type, 'topic') && $upper_key == $def_lang) {
          $queries['xpathparser:' . $i] = $values['query'];
        }
        elseif (strpos($type, 'newsroom_types')) {
          $queries['xpathparser:' . $i] = $values['query'] . '[@lang="' . $upper_key . '"]/text()';
        }
        // Mapping arrays.
        $mapping[$i] = array(
          'source' => 'xpathparser:' . $i,
          'target' => $field . ':et:' . $lang_key,
          'unique' => FALSE,
        );
        // Additional values.
        if (isset($values['options'])) {
          foreach ($values['options'] as $key => $option) {
            $mapping[$i][$key] = $option;
          }
        }
        // Guid is the "unique" field but let's do this "dinamically".
        if (isset($values['unique'])) {
          $mapping[$i]['unique'] = TRUE;
        }
        $i++;
      }
    }
    // Not translatable fields.
    else {
      // Xpath queries.
      $queries['xpathparser:' . $i] = $values['query'];
      // Mapping arrays.
      $mapping[$i] = array(
        'source' => 'xpathparser:' . $i,
        'target' => $field,
        'unique' => FALSE,
      );

      if (isset($values['options'])) {
        foreach ($values['options'] as $key => $option) {
          $mapping[$i][$key] = $option;
        }
      }
      if (isset($values['unique'])) {
        $mapping[$i]['unique'] = TRUE;
      }
      $i++;
    }
  }

  // Build also the debug and raw_xml arrays.
  foreach ($queries as $xpath => $query) {
    $debug[$xpath] = $raw_xml[$xpath] = 0;
  }

  return array(
    'mapping' => $mapping,
    'queries' => $queries,
    'debug' => $debug,
    'raw_xml' => $raw_xml,
  );
}

/**
 * Build tampers programmatically.
 */
function _nexteuropa_newsroom_dynamic_tamper($tamper) {
  $def_lang = language_default()->language;

  if ($tamper == NULL) {
    $feeds_tamper = new stdClass();
    $feeds_tamper->disabled = FALSE;
    $feeds_tamper->api_version = 2;
    $feeds_tamper->id = 'newsroom_items_multilingual-blank_source_1-default_value';
    $feeds_tamper->importer = NEWSROOM_ITEM_IMPORTER;
    $feeds_tamper->source = 'Blank source 1';
    $feeds_tamper->plugin_id = 'default_value';
    $feeds_tamper->settings = array(
      'default_value' => $def_lang,
    );
    $feeds_tamper->weight = 0;
    $feeds_tamper->description = 'Set default language';
  }
  else {
    $feeds_tamper = new stdClass();
    $feeds_tamper->disabled = FALSE;
    $feeds_tamper->api_version = 2;
    $feeds_tamper->id = $tamper['id'];
    $feeds_tamper->importer = $tamper['importer'];
    $feeds_tamper->source = $tamper['source'];
    $feeds_tamper->plugin_id = $tamper['plugin_id'];
    $feeds_tamper->settings = $tamper['settings'];
    $feeds_tamper->weight = 0;
    $feeds_tamper->description = $tamper['description'];
  }

  // Delete a pre-existing tamper with the same id.
  db_delete('feeds_tamper')
    ->condition('id', $feeds_tamper->id)
    ->execute();
  // Save the tamper.
  feeds_tamper_save_instance($feeds_tamper);
}

/**
 * Helper function to enable languages.
 *
 * @param object $importer
 *   The importer to import.
 */
function _nexteuropa_newsroom_import_importer($importer) {
  // Those Api calls are copied from the submit function of the
  // import form provided by the feeds_ui module. The alpha8 version
  // of Feeds (the one used in the platform) had a bugged implementation,
  // fixed using the dev version code for the submit.
  // Create a copy of the importer to preserve config.
  $save = feeds_importer($importer->id);
  $save->setConfig($importer->config);
  foreach (array('fetcher', 'parser', 'processor') as $type) {
    $save->setPlugin($importer->config[$type]['plugin_key']);
    $save->$type->setConfig($importer->config[$type]['config']);
  }
  $save->save();
}

/**
 * Helper function to delete menu, menu links, taxonomies.
 */
function nexteuropa_newsroom_delete($name, $type = 'menu', $op = 'items') {
  switch ($type) {
    case 'menu':
      if ($op == 'items') {
        menu_delete_links($name);
      }
      else {
        menu_delete(array('menu_name' => $name));
      }
      break;

    case 'vocabulary':
      $voc = taxonomy_vocabulary_machine_name_load($name);
      if (!empty($voc)) {
        if ($op == 'items') {
          $terms = taxonomy_get_tree($voc->vid);
          foreach ($terms as $term) {
            taxonomy_term_delete($term->tid);
          }
        }
        else {
          taxonomy_vocabulary_delete($voc->vid);
        }
      }
      break;

    case 'node':
      $node_type = array($name);
      $query = new EntityFieldQuery();
      $query->entityCondition('entity_type', 'node')
        ->propertyCondition('type', $node_type, 'IN');
      $result = $query->execute();
      foreach ($result['node'] as $node) {
        node_delete($node->nid);
      }
      break;
  }
}

/**
 * Implements hook_url_inbound_alter().
 *
 * Resolves alias if the content is not translated.
 */
function nexteuropa_newsroom_url_inbound_alter(&$path, $original_path, $path_language) {
  // Check if no url alias has not been found for incoming path.
  if ($path && $path == $original_path) {
    // Resolve alias if the content is not translated to current language. Get
    // alias of existing translation.
    foreach (array_keys(language_list()) as $language) {
      if ($source = drupal_lookup_path('source', $path, $language)) {
        // Check if we are at the document page.
        if (strpos($source, 'node/') === 0) {
          $path = $source;
          break;
        }
      }
    }
  }
}

/**
 * Implements hook_url_outbound_alter().
 *
 * Resolves alias from node language if the content is not translated.
 */
function nexteuropa_newsroom_url_outbound_alter(&$path, &$options, $original_path) {
  if (preg_match('/^node\/\d+$/', $path) && $node = menu_get_object('node', 1, $path)) {
    if ($alias = drupal_get_path_alias($path, $node->language)) {
      $path = $alias;
    }
  }
}

/**
 * Implements hook_url_strongarm_alter().
 */
function nexteuropa_newsroom_strongarm_alter(&$variables) {
  // Unset a "dynamic variable" created by cce_basic_config.
  unset($variables['image_captcha_fonts']);
  unset($variables['print_pdf_pdf_tool']);
}

/**
 * Rebuild multilingual importers.
 */
function _nexteuropa_newsroom_rebuild_importers() {
  // Remove importers.
  $importers = array(
    'items' => NEWSROOM_ITEM_IMPORTER,
    'services' => NEWSROOM_SERVICE_IMPORTER,
    'topics' => NEWSROOM_TOPIC_IMPORTER,
    'types' => NEWSROOM_TYPE_IMPORTER,
  );

  foreach ($importers as $key => $importer) {
    feeds_importer($importer)->delete();
    // Recreate them.
    call_user_func('_nexteuropa_newsroom_create_multilingual_' . $key . '_importer');
  }

  $form['rebuilt'] = array(
    '#type' => 'markup',
    '#markup' => t('Importers have been rebuilt'),
  );

  return $form['rebuilt'];
}

/**
 * Check if a field is translatable.
 *
 * @param array $premapping
 *   Premappings array.
 */
function _nexteuropa_newsroom_check_translations(array $premapping) {
  // Build an array with langauge settings for the fields.
  foreach ($premapping as $fieldname => $values) {
    // Sanitize fieldname.
    $attribute = strrchr($fieldname, ':');
    $sanitized_name = isset($values['original_field']) ? $values['original_field'] : str_replace($attribute, '', $fieldname);
    $field = field_info_field($sanitized_name);
    $language = field_is_translatable('node', $field);
    $premapping[$fieldname]['language'] = $language;
  }

  return $premapping;
}

/**
 * Implements hook_node_presave().
 */
function nexteuropa_newsroom_node_presave($node) {
  if ($node->type == 'newsroom_item' && variable_get('newsroom_patterns', FALSE)) {
    // Get all the types.
    if (isset($node->field_newsroom_item_type['und'][0]['tid'])) {
      $type_tid = $node->field_newsroom_item_type['und'][0]['tid'];
      $type = pathauto_cleanstring(drupal_strtolower(taxonomy_term_load($type_tid)->name));
      $conf = variable_get('newsroom_' . $type . '_root', FALSE);
      if ($conf) {
        $node->path['pathauto'] = FALSE;
        $node->path['alias'] = $conf . '/' . pathauto_cleanstring($node->title);
      }
    }
  }
}

/**
 * Implements hook_block_info().
 */
function nexteuropa_newsroom_block_info() {
  $blocks = array();
  $blocks['newsroom_topic_summary'] = array(
    'info' => t('Newsroom Topic Summary'),
  );
  $blocks['newsroom_admin_tools'] = array(
    'info' => t('Newsroom administration buttons'),
  );
  $blocks['newsroom_newsletter_subscription'] = array(
    'info' => t('Newsroom Newsletter Subscription'),
  );
  $blocks['newsroom_list_filter'] = array(
    'info' => t('Newsroom List Filter'),
  );
  $blocks['newsroom_proposal'] = array(
    'info' => t('News proposal'),
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function nexteuropa_newsroom_block_view($delta = '') {
  switch ($delta) {
    case 'newsroom_topic_summary':
      $block['subject'] = _nexteuropa_newsroom_subject();
      $block['content'] = _nexteuropa_nexteuropa_newsroom_contents();
      break;

    case 'newsroom_admin_tools':
      $block['subject'] = NULL;
      $block['content'] = _nexteuropa_newsroom_tools();
      break;

    case 'newsroom_newsletter_subscription':
      $block['subject'] = NULL;
      $block['content'] = _nexteuropa_newsroom_newsletter_subscription();
      break;

    case 'newsroom_list_filter':
      $block['subject'] = NULL;
      $block['content'] = _nexteuropa_newsroom_list_filter();
      break;

    case 'newsroom_proposal':
      $blocks['subject'] = t('Newsroom item proposal');
      $blocks['content'] = _nexteuropa_newsroom_block_news_proposal();
      break;
  }
  return $block;
}

/**
 * Implements hook_date_format_types().
 */
function nexteuropa_newsroom_date_format_types() {
  return array(
    'date_only' => t('Date only'),
  );
}

/**
 * Implements hook_date_formats().
 */
function nexteuropa_newsroom_date_formats() {
  return array(
    array(
      'type' => 'date_only',
      'format' => 'd/m/Y',
      'locales' => array(),
    ),
  );
}

/**
 * Returns universe URL.
 *
 * @param string $universe_id
 *   Unique universe ID.
 *
 * @return string
 *   Universe URL.
 */
function _nexteuropa_newsroom_get_universe_url($universe_id) {
  return NEWSROOM_URL . $universe_id . '/';
}

/**
 * Returns newsroom URL.
 *
 * @return string
 *   Newsroom URL.
 */
function _nexteuropa_newsroom_get_newsroom_url() {
  return 'newsroom/' . implode('/', func_get_args());
}

/**
 * Returns block content.
 *
 * Buttons to easily manage newsroom items. Edit in newsroom, re-import etc.
 *
 * @return string
 *   Content
 */
function _nexteuropa_newsroom_tools() {
  $content = '';
  $newsroom_item = menu_get_object();
  if ($newsroom_item->type == 'newsroom_item') {
    $newsroom_id_field = field_get_items('node', $newsroom_item, 'field_newsroom_item_id');
    $newsroom_id = $newsroom_id_field[0]['value'];
    $links = array();
    if (user_access(NEWSROOM_EDIT_ACCESS)) {
      global $_newsroom_universe_url;
      $links['edit'] = array(
        'text' => '<span class="glyphicon glyphicon-edit"></span> Edit item in the Newsroom',
        'path' => $_newsroom_universe_url . variable_get('newsroom_single_item_edit_segment', 'item.cfm?item_id=') . $newsroom_id,
        'options' => array(
          'html' => TRUE,
          'attributes' => array('class' => 'btn btn-success'),
        ),
      );
    }
    if (user_access(NEWSROOM_IMPORT_ACCESS)) {
      $links['reimport'] = array(
        'text' => '<span class="glyphicon glyphicon-refresh"></span> Re-import from the Newsroom',
        'path' => 'news-import/' . $newsroom_id . '/reimport',
        'options' => array(
          'html' => TRUE,
          'attributes' => array('class' => 'btn btn-danger'),
        ),
      );
    }

    foreach ($links as $link) {
      $content .= '<div class="btn-group-sm btn-group">' . theme('link', $link) . '</div>';
    }

    if (!empty($content)) {
      $content = '<div class="btn-toolbar">' . $content . '</div>';
    }
  }
  return $content;
}

/**
 * Validate if a given Newsroom Universe exists.
 *
 * @param string $universe_id
 *   Newsroom Universe ID.
 *
 * @return bool
 *   Newsroom Universe exists or not.
 */
function _nexteuropa_newsroom_validate_universe($universe_id = NULL) {
  if ($universe_id) {
    // logout.cfm is used because it is always available if a universe exists.
    $test = chr_curl_http_request(NEWSROOM_URL . $universe_id . '/logout.cfm');
    return $test->code == 200;
  }

  return FALSE;
}

/**
 * Returns the Click-through setting for a given item.
 *
 * @param EntityMetadataWrapper $node_wrapper
 *   Newsroom Item node wrapper.
 *
 * @return string
 *   Value of the Click-through field of the item type.
 */
function _nexteuropa_newsroom_item_type_teaser_only_settings(EntityMetadataWrapper $node_wrapper) {
  $value = NULL;
  $type = $node_wrapper->field_newsroom_item_type->value();
  if ($type) {
    $type_wrapper = entity_metadata_wrapper('taxonomy_term', $type);
    if ($type_wrapper) {
      $value = $type_wrapper->field_direct_link_if_teaser_only->value();
    }
  }
  return $value;
}

/**
 * Try to resolve each taxonomy term with a corresponding ID to map.
 *
 * @param string $field_name
 *   The mapping field.
 * @param string $field_value
 *   The mapping field value.
 * @param bool $reset
 *   If set to TRUE, will return an empty string if no mapping found.
 *
 * @return array
 *   Taxonomy ids.
 */
function _nexteuropa_newsroom_technical_fields_to_tid($field_name, $field_value, $reset = TRUE) {
  // Let's initiate term_ids to field value, in case we can't map it.
  $term_ids = $reset ? '' : $field_value;
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'taxonomy_term')
      ->fieldCondition($field_name, 'value', $field_value)
      ->execute();
  $result = $query->execute();
  if (isset($result['taxonomy_term'])) {
    $term_ids = array_keys($result['taxonomy_term']);
  }
  return $term_ids;
}

/**
 * Returns block with the link to newsroom proposal form.
 *
 * @global object $user
 *   Global user object.
 * @global string $base_url
 *   Global URL.
 *
 * @return string
 *   Block content.
 */
function _nexteuropa_newsroom_block_news_proposal() {

  if (!user_access(NEWSROOM_PROPOSAL_ACCESS)) {
    return NULL;
  }

  global $base_url;

  $topic_id = NULL;

  // Try to get Topic ID from the entity.
  $node = menu_get_object();

  if ($node) {
    if (isset($node->field_associated_newsroom_topic[LANGUAGE_NONE][0]['tid']) && !empty($node->field_associated_newsroom_topic[LANGUAGE_NONE][0]['tid'])) {
      $topic_id = $node->field_associated_newsroom_topic[LANGUAGE_NONE][0]['tid'];
    }
    elseif (isset($node->og_group_ref[LANGUAGE_NONE][0]['target_id']) && !empty($node->og_group_ref[LANGUAGE_NONE][0]['target_id'])) {
      $group = node_load($node->og_group_ref[LANGUAGE_NONE][0]['target_id']);
      if (isset($group->field_associated_newsroom_topic[LANGUAGE_NONE][0]['tid']) && !empty($group->field_associated_newsroom_topic[LANGUAGE_NONE][0]['tid'])) {
        $topic_id = $group->field_associated_newsroom_topic[LANGUAGE_NONE][0]['tid'];
      }
    }
  }
  else {
    // Taxonomy term override.
    $taxonomy_term = NULL;
    $current_page_path = current_path();

    if (strpos($current_page_path, 'taxonomy/term') !== FALSE) {
      // Never sure what menu_callback will get you with.
      // A view overridding a taxo page.
      $url_tokens = explode('/', $current_page_path);
      if (isset($url_tokens[2]) && is_numeric($url_tokens[2])) {
        $taxonomy_term = taxonomy_term_load($url_tokens[2]);

        if (isset($taxonomy_term->field_associated_newsroom_topic[LANGUAGE_NONE][0]['tid']) && !empty($taxonomy_term->field_associated_newsroom_topic[LANGUAGE_NONE][0]['tid'])) {
          $topic_id = $taxonomy_term->field_associated_newsroom_topic[LANGUAGE_NONE][0]['tid'];
        }
      }
    }
  }

  $output = '<div class="communityTools">';
  $output .= '<div class="RSSButton"><a href="' . $base_url . '/news-proposal/?topic_id=' . $topic_id . '">' . t('Propose newsroom item') . '</a></div>';
  $output .= '</div>';

  return $output;
}

/**
 * Returns the newsroom list filter form.
 */
function _nexteuropa_newsroom_list_filter() {
  $topics_vocanulary = taxonomy_vocabulary_machine_name_load(NEWSROOM_TOPIC_VOCABULARY);

  // Load all relevant nids by loading the same view without pager.
  $menu_object = menu_get_item();
  if ($menu_object['page_callback'] == 'views_page' && !empty($menu_object['page_arguments']) && $menu_object['page_arguments'][0] == 'newsroom') {
    $nids = array();
    $arguments = $menu_object['theme_arguments'];
    $fields = array(
      'nid' => array(
        'id' => 'nid',
        'table' => 'node',
        'field' => 'nid',
        'label' => '',
        'exlude' => TRUE,
        'element_label_colon' => FALSE,
      ),
    );
    $view = views_get_view('newsroom');
    $view->set_display($menu_object['page_arguments'][1]);
    $view->set_arguments($arguments);
    $view->display[$view->current_display]->handler->set_option('fields', $fields);
    $view->display[$view->current_display]->handler->set_option('pager', array('type' => 'none', 'options' => array()));
    $view->pre_execute();
    $view->execute();

    foreach ($view->result as $node) {
      $nids[] = $node->nid;
    }

    $query = db_select('taxonomy_index', 'ti');
    $query->fields('ti', array('tid'));
    $query->join('taxonomy_term_data', 't', 't.tid = ti.tid');
    $query->fields('t', array('name'));
    $query->join('field_data_field_newsroom_category_domain', 'd', 'd.entity_id = ti.tid');
    $query->fields('d', array('field_newsroom_category_domain_value'));
    $query->condition('t.vid', $topics_vocanulary->vid);
    if (!empty($nids)) {
      $query->condition('ti.nid', $nids);
    }
    $query->condition('d.entity_type', 'taxonomy_term');
    $result = $query->execute();

    $countries = array();
    $topics = array();
    while ($record = $result->fetchAssoc()) {
      if ($record['field_newsroom_category_domain_value'] == 'Country') {
        $countries[$record['tid']] = $record['name'];
      }
      else {
        $topics[$record['tid']] = $record['name'];
      }
    }

    // Load full otpion list based on field_newsroom_topics values.
    $field_instance = field_info_instance('node', 'field_newsroom_topics', 'newsroom_item');
    $field = field_info_field('field_newsroom_topics');
    $temp = new stdClass();
    $temp->type = 'newsroom_item';
    node_object_prepare($temp);
    $options = taxonomy_options_list($field, $field_instance, 'node', $temp);

    // Reduce options to existing values only.
    $countries = array_intersect_key($options, $countries);
    $topics = array_intersect_key($options, $topics);
    // Change values from tid keys term name based.
    if (variable_get('newsroom_url_mode', 'name') == 'name') {
      $countries = _nexteuropa_newsroom_options_tid_to_name($countries);
      $topics = _nexteuropa_newsroom_options_tid_to_name($topics);
    }
    // Add - None - option.
    $none = array('0' => t('- None -'));
    $countries = $none + $countries;
    $topics = $none + $topics;

    return drupal_get_form('nexteuropa_newsroom_list_filter_form', $countries, $topics, $arguments);
  }

  return '';
}

/**
 * Returns the Newsroom title and link depending by taxonomy terms.
 *
 * @return string
 *   Subject.
 */
function _nexteuropa_newsroom_subject() {
  $newsroom_subject = l(t('Newsroom'), _nexteuropa_newsroom_get_newsroom_url('all'));
  if (!drupal_is_front_page()) {
    $topic_tid = menu_get_object('views_arg', 2);
    $topic_term = taxonomy_term_load($topic_tid);
    if (isset($topic_term->name)) {
      $newsroom_subject = l(t('Newsroom'), _nexteuropa_newsroom_get_newsroom_url('all', $topic_term->tid));
    }
  }
  return $newsroom_subject;
}

/**
 * Returns a block content.
 *
 * Loops through newsroom type at top level and display the corresponding
 * content and link for each newsroom type.
 *
 * @return string
 *   Content.
 */
function _nexteuropa_nexteuropa_newsroom_contents() {
  $block_settings = _nexteuropa_newsroom_get_summary_block_tid();
  $topic_tids = array();
  $topic_name = array();
  // Sticky items (Centrally published).
  $sticky = TRUE;
  if (!drupal_is_front_page()) {
    if (!$block_settings['display']) {
      return '';
    }
    $sticky = FALSE;
    if (!empty($block_settings['topic'])) {
      foreach ($block_settings['topic'] as $topic) {
        $topic_tids[] = $topic->tid;
        $topic_name[] = $topic->name;
      }
    }
  }

  $newsroom_content = _nexteuropa_newsroom_content($block_settings['type'], FALSE, implode('+', $topic_tids), $sticky, $block_settings['topic'], $block_settings['topic_operator']);

  // Prepend RSS link if there is content.
  if (!empty($newsroom_content)) {
    $newsroom_content = _nexteuropa_newsroom_build_rss_link($topic_tids, $topic_name) . $newsroom_content;
  }

  return $newsroom_content;
}

/**
 * Newsletter subscription block.
 */
function _nexteuropa_newsroom_newsletter_subscription() {
  $content = array();
  $view = views_get_view('newsletter_subscription');

  if ($view) {
    $view->set_display('block');
    $view->pre_execute();
    $view->execute();
    if (!empty($view->result)) {
      $service = array_shift($view->result);
      $content = drupal_get_form('nexteuropa_newsroom_newsletter_subscription_form', array('tid' => $service->field_field_newsroom_service_id[0]['raw']['safe_value'], 'name' => $service->taxonomy_term_data_name));
    }
  }

  return $content;
}

/**
 * Builds rss link.
 *
 * @param array $topic_tids
 *   Topics ids.
 * @param string $topic_name
 *   Topic name.
 *
 * @return string
 *   RSS.
 */
function _nexteuropa_newsroom_build_rss_link(array $topic_tids, $topic_name) {
  $topic_url = count($topic_tids) > 0 ? implode('+', $topic_tids) : 'all';
  $rss_path = _nexteuropa_newsroom_get_newsroom_url('all', $topic_url, 'feed');
  $rss_title = count($topic_name) > 0 ? 'RSS feed : ' . implode(', ', $topic_name) : 'RSS feed';
  $rss = '<div class="newsroom_rss">';
  $rss .= theme('feed_icon', array(
    'url' => $rss_path,
    'title' => $rss_title,
  ));
  $rss .= l($rss_title, $rss_path);
  $rss .= '</div>';

  return $rss;
}

/**
 * Creates default set of importers.
 * 
 * @param int $universe_id
 *   Universe ID.
 * @param string $context
 *   Execution context.
 */
function _nexteuropa_newsroom_create_default_importers($universe_id, $context = 'admin') {
  $universe_url = _nexteuropa_newsroom_get_universe_url($universe_id);
  // Run the multilingual imports if required.
  $importers['newsroom_types_multilingual_importer'] = array(
    'segment' => variable_get('newsroom_single_type_import_segment', NEWSROOM_TYPE_SEGMENT),
    'importer' => NEWSROOM_TYPE_IMPORTER,
  );
  $importers['newsroom_services_multilingual_importer'] = array(
    'segment' => variable_get('newsroom_single_service_import_segment', NEWSROOM_SERVICE_SEGMENT),
    'importer' => NEWSROOM_SERVICE_IMPORTER,
  );
  $importers['newsroom_topics_multilingual_importer'] = array(
    'segment' => variable_get('newsroom_single_topic_import_segment', NEWSROOM_TOPIC_SEGMENT),
    'importer' => NEWSROOM_TOPIC_IMPORTER,
  );
  $importers['newsroom_items_multilingual_importer'] = array(
    'segment' => variable_get('newsroom_single_item_import_segment', NEWSROOM_ITEM_SEGMENT),
    'importer' => NEWSROOM_ITEM_IMPORTER,
  );

  foreach ($importers as $importer) {
    $feed_source = feeds_source($importer['importer']);
    $config = $feed_source->getConfig();
    $config['FeedsHTTPFetcher']['source'] = $universe_url . $importer['segment'];
    $feed_source->setConfig($config);
    $feed_source->save();
    $batch = array(
      'title' => t('Importing !title', array('!title' => $importer['importer'])),
      'operations' => array(
        array('feeds_batch', array('import', $importer['importer'], 0)),
      ),
      'progress_message' => t('Current: @current | Remaining:
      @remaining | Total: @total | Percentage: @percentage | Estimate:
      @estimate | Elapsed: @elapsed'),
    );
    $batch['progressive'] = FALSE;
    batch_set($batch);
  }
  if ($context == 'drush') {
    drush_print(dt('Importing items, this might take a while...'));
    drush_backend_batch_process();
  }
}

/**
 * Implements hook_views_handlers().
 */
function nexteuropa_views_handlers() {
  return array(
    'handlers' => array(
      'nexteuropa_views_handler_field_taxonomy' => array(
        'parent' => 'views_handler_field_taxonomy',
        'path' => drupal_get_path('module', 'newsroom') . '/views',
      ),
    ),
  );
}

/**
 * Implements hook_views_data_alter().
 */
function nexteuropa_newsroom_views_data_alter(&$data) {
  $data['node']['nexteuropa_newsroom_term_node_tid_depth'] = array(
    'help' => t('Display content if it has the selected taxonomy terms, or children of the selected terms. Due to additional complexity, this has fewer options than the versions without depth.'),
    'real field' => 'nid',
    'argument' => array(
      'title' => t('Newsroom: Has taxonomy term ID (with depth)'),
      'handler' => 'nexteuropa_newsroom_handler_argument_term_node_tid_depth',
      'accept depth modifier' => TRUE,
    ),
  );
  // Term name field.
  $data['taxonomy_term_data']['name'] = array(
    'title' => t('Name'),
    'help' => t('The taxonomy term name.'),
    'field' => array(
      'handler' => 'nexteuropa_newsroom_views_handler_field_taxonomy',
      'click sortable' => TRUE,
    ),
  );
}

/**
 * Implements hook_feeds_plugins().
 */
function nexteuropa_newsroom_feeds_plugins() {
  $info = array();
  // A plugin needs to derive either directly or indirectly from FeedsFetcher,
  // FeedsParser or FeedsProcessor.
  $info['NewsroomDeleteNodeProcessor'] = array(
    'name' => 'Newsroom Infso Outdated Items',
    'description' => 'Deletes outdated items by tracking a specific RSS feed.',
    'handler' => array(
      'parent' => 'FeedsProcessor',
      'class' => 'NewsroomDeleteNodeProcessor',
      'file' => 'NewsroomDeleteNodeProcessor.inc',
      'path' => drupal_get_path('module', 'nexteuropa_newsroom') . '/plugins',
    ),
  );

  return $info;
}

/**
 * Calculates the tid to use to filter the newsroom_topic_summary block content.
 *
 * @return array
 *   NR Topic tid
 */
function _nexteuropa_newsroom_get_summary_block_tid() {

  $current_path = menu_get_item();
  $topic_operator = NEWSROOM_TOPIC_OPERATOR_OR;
  $selected_topics = array();
  $selected_topic_highlights = array();
  $selected_types = array();
  $config['display'] = FALSE;
  $newsroom_selection_node = FALSE;

  // We are on a view object, it's a term argument,
  // let's use to filter results.
  if ($current_path['page_callback'] === 'views_page' && $current_path['path'] === 'taxonomy/term/%') {
    $argument_values = array_values($current_path['page_arguments']);
    $last_argument_element = end($argument_values);
    // We may have a term page, let's try to load it.
    if (is_numeric($last_argument_element)) {
      $entity = taxonomy_term_load($last_argument_element);
      $selected_topics[] = $entity->tid;
    }
  }
  elseif ($current_path['page_callback'] === 'node_page_view') {
    // It is a node page take node entity from request.
    $entity = $current_path['map'][1];

    // If newsroom selection type, load same entity as selection.
    $newsroom_selection_node = $entity->type == 'newsroom_selection' ? $entity : FALSE;
  }
  elseif (isset($current_path['page_arguments'][0]->tid)) {
    // It's taxonomy term without views.
    $entity = $current_path['page_arguments'][0];
    $selected_topics[] = $entity->tid;
  }

  // Check if selection config is set.
  if (isset($entity->field_associated_newsroom_select) && !empty($entity->field_associated_newsroom_select)) {
    // If it has the selection field, try to load config.
    $newsroom_selection_node = node_load($entity->field_associated_newsroom_select['und'][0]['target_id']);
  }

  if ($newsroom_selection_node) {

    if (!empty($newsroom_selection_node->field_newsroom_topic_operator)) {
      $topic_operator = $newsroom_selection_node->field_newsroom_topic_operator['und'][0]['value'];
    }

    $topic_config = field_get_items('node', $newsroom_selection_node, 'field_selected_topics');
    $selected_topics = array();
    if ($topic_config) {
      foreach ($topic_config as $term_ref) {
        $selected_topics[] = $term_ref['target_id'];
      }
    }

    // Anywhere else in the script.
    $topic_highlight_config = field_get_items('node', $newsroom_selection_node, 'field_selected_topic_highlights');

    $selected_topic_highlights = array();
    if ($topic_highlight_config) {
      foreach ($topic_highlight_config as $term_ref) {
        $selected_topic_highlights[] = $term_ref['target_id'];
      }
    }
    $blocks_by = variable_get('newsroom_block_by', 'type');
    $grouping_field = $blocks_by == 'collection' ? 'field_selected_categories' : 'field_selected_types';
    $key = $blocks_by == 'collection' ? 'target_id' : 'tid';
    $type_config = field_get_items('node', $newsroom_selection_node, $grouping_field);

    if ($type_config) {
      foreach ($type_config as $term_ref) {
        $selected_types[] = $term_ref[$key];
      }
    }
    $config['display'] = TRUE;
  }
  elseif (isset($entity->field_associated_newsroom_topic) && !empty($entity->field_associated_newsroom_topic)) {
    // If it has the associated field, try to load topic.
    $selected_topics = array($entity->field_associated_newsroom_topic['und'][0]['tid']);
    $config['display'] = TRUE;
  }

  $config['topic'] = count($selected_topics) > 0 ? taxonomy_term_load_multiple($selected_topics) : array();
  $config['topic_operator'] = $topic_operator;
  $config['topic_highlights'] = count($selected_topic_highlights) > 0 ? taxonomy_term_load_multiple($selected_topic_highlights) : array();
  $config['type'] = _nexteuropa_newsroom_get_grouping_terms($selected_types);

  return $config;
}

/**
 * Item types or Collection to group by.
 *
 * @return array
 *   Terms
 */
function _nexteuropa_newsroom_get_grouping_terms($selected) {
  // Get cached terms if exists.
  $cache = cache_get('newsroom:grouping_terms');
  if ($cache) {
    $terms = $cache->data;
  }
  else {
    $blocks_by = variable_get('newsroom_block_by', 'type');

    if ($blocks_by !== 'collection') {
      // We'll loop through the newsroom by type vocabulary.
      $newsroom_type_vocabulary = taxonomy_vocabulary_machine_name_load(NEWSROOM_TYPE_VOCABULARY);
      $terms = array();
      if (is_object($newsroom_type_vocabulary) && $newsroom_type_vocabulary !== FALSE) {
        $terms = taxonomy_get_tree($newsroom_type_vocabulary->vid, 0, 1, TRUE);
        foreach ($terms as $key => $term) {
          $test = i18n_get_object('taxonomy_term', $term->tid);
          $terms[$key] = $test->get_object();
        }
      }

      // Filter types if needed.
      if (!empty($selected)) {
        foreach ($terms as $key => $type) {
          if (!in_array($type->tid, $selected)) {
            unset($terms[$key]);
          }
        }
      }
    }
    else {
      if (!empty($selected)) {
        $terms = taxonomy_term_load_multiple($selected);
      }
      else {

        $view = views_get_view('newsroom_term_selection');
        $view->set_display('entityreference_3');
        $view->pre_execute();
        $view->execute();

        $term_items = $view->result;
        $terms = array();

        foreach ($term_items as &$term_item) {
          $term = taxonomy_term_load($term_item->tid);
          if ($term) {
            $terms[] = $term;
          }
        }
      }
    }
    cache_set('newsroom:grouping_terms', $terms, 'cache_newsroom', time() + 360);
  }

  return $terms;
}

/**
 * Call to the content view, set up the argument vocabulary by vocabulary.
 *
 * @param array $newsroom_grouping_terms
 *   Newroom type terms.
 * @param bool $full_display
 *   Show full display.
 * @param int $newsroom_topic_tids
 *   Main tid.
 * @param bool $sticky
 *   Centrally published.
 *
 * @return string
 *   Content.
 */
function _nexteuropa_newsroom_content(array $newsroom_grouping_terms, $full_display = FALSE, $newsroom_topic_tids = 'all', $sticky = NULL, $topics = array(), $topic_operator = NEWSROOM_TOPIC_OPERATOR_OR) {
  $blocks_by = variable_get('newsroom_block_by', 'type');
  $newsroom_boxes = array();
  // We skip the newsroom topic param if it is empty string.
  if (!empty($newsroom_topic_tids)) {
    $view_arguments[1] = $newsroom_topic_tids;
  }

  // Custom Agenda block if needed.
  if (variable_get('newsroom_display_agenda', 1) && $agenda_types = _nexteuropa_newsroom_agenda_types()) {
    $view_arguments[0] = implode('+', array_keys($agenda_types));
    $agenda_box = _nexteuropa_newsroom_fetch_content_view($view_arguments, NEWSROOM_CALENDAR_BLOCK, 'agenda', $sticky, $full_display, $topic_operator);

    if ($agenda_box && $agenda_box['block']['content'] != '') {
      $full_list_url = _nexteuropa_newsroom_get_newsroom_url('calendar');
      $newsroom_boxes[] = array_merge($agenda_box, array(
        'title' => l(t('Calendar'), $full_list_url),
        'list_link' => l(t('<span class="more">%1</span>', array('%1' => t('More ongoing activities'))), $full_list_url, array('html' => TRUE)),
        'classes' => array('agenda', 'highlighted'),
        'id' => 'newsroom-agenda-block',
        'highlight' => TRUE,
        'agenda' => TRUE,
        'weight' => '0',
      ));
    }
  }

  if (count($newsroom_grouping_terms) > 0) {
    foreach ($newsroom_grouping_terms as $newsroom_grouping_term) {
      $default_view_display = 'default_newsroom';
      $classes = array('term-' . $newsroom_grouping_term->tid);
      $newsroom_block_id = '';
      if ($blocks_by !== 'collection') {
        $newsroom_type_tids = _nexteuropa_newsroom_get_children($newsroom_grouping_term->tid, $newsroom_grouping_term->vid);
        $view_arguments[0] = $newsroom_type_tids;
        $newsroom_type_display = field_get_items('taxonomy_term', $newsroom_grouping_term, 'field_newsroom_type');

        // Some newsroom type are not using the normal sorting.
        // This is machine-name defined by newsroom type.
        if ($newsroom_type_display) {
          switch ($newsroom_type_display[0]['value']) {
            case 'events':
              $default_view_display = 'events';
              break;

            case 'agenda':
              $default_view_display = 'agenda';
              break;

            case 'consultation_funding':
              $default_view_display = 'consultation_funding';
              break;
          }
        }
      }
      else {
        $view_arguments[0] = $newsroom_grouping_term->tid;
      }

      $newsroom_view_exec = _nexteuropa_newsroom_fetch_content_view($view_arguments, $newsroom_grouping_term, $default_view_display, $sticky, $full_display, $topic_operator);

      // If we have some content, let's add a title.
      if ($newsroom_view_exec && $newsroom_view_exec['block']['content'] != '') {
        $topic_is_highlighted = _nexteuropa_newsroom_type_is_highlighted($newsroom_grouping_term);
        if ($topic_is_highlighted) {
          // Controls width.
          $classes[] = 'featured';
          // Controls border.
          $classes[] = 'highlighted';
        }

        $clean_url_type_name = pathauto_cleanstring($newsroom_grouping_term->name);
        $newsroom_block_id = 'newsroom-block-' . $clean_url_type_name;
        if (count($topics) == 1) {
          $topics_segment = pathauto_cleanstring($topics[key($topics)]->name);
        }
        else {
          $topics_segment = $newsroom_topic_tids;
        }
        $newsroom_url_mode = variable_get('newsroom_url_mode', 'name');
        if ($newsroom_url_mode == 'tid') {
          $full_list_url = _nexteuropa_newsroom_get_newsroom_url($newsroom_grouping_term->tid, $topics[key($topics)]->tid);
        }
        else {
          $full_list_url = _nexteuropa_newsroom_get_newsroom_url($clean_url_type_name, $topics_segment);
        }

        // Check latest item in box.
        $created = 0;

        foreach ($newsroom_view_exec['view']->result as $row) {
          $created = $row->node_created > $created ? $row->node_created : $created;
        }

        $newsroom_boxes[] = array_merge($newsroom_view_exec, array(
          'title' => l($newsroom_grouping_term->name, $full_list_url),
          'list_link' => l(t('<span class="more">More</span> <span class="more_type">%1</span>', array('%1' => $newsroom_grouping_term->name)), $full_list_url, array('html' => TRUE)),
          'classes' => $classes,
          'id' => $newsroom_block_id,
          'highlight' => $topic_is_highlighted,
          'agenda' => FALSE,
          'last_update' => $created,
          'weight' => $newsroom_grouping_term->weight,
        ));
      }
    }
  }

  return !empty($newsroom_boxes) ? _nexteuropa_newsroom_render_boxes($newsroom_boxes) : '';
}

/**
 * Helper to check if topic is highlighted.
 *
 * @return bool
 *   is highlighted or not
 */
function _nexteuropa_newsroom_type_is_highlighted($term) {
  if ($term === NEWSROOM_CALENDAR_BLOCK) {
    return FALSE;
  }
  $item_wrapper = entity_metadata_wrapper('taxonomy_term', $term);
  return $item_wrapper->__isset('field_newsroom_highlighted') ? $item_wrapper->field_newsroom_highlighted->value() : FALSE;
}

/**
 * Render the boxes for the block.
 *
 * @return string
 *   markup
 */
function _nexteuropa_newsroom_render_boxes($boxes) {
  $newsroom_content = '';
  $columns_newsroom = array(
    1 => array(
      'visible' => FALSE,
      'content' => '',
    ),
    2 => array(
      'visible' => FALSE,
      'content' => '',
    ),
  );
  $num_columns = variable_get('newsroom_summary_block_columns', 1);

  // Sort boxes based on configuration.
  uasort($boxes, '_nexteuropa_newsroom_sort_newsroom_boxes');

  $newsroom_row_number = 1;
  foreach ($boxes as $box) {
    $active_column = 1;
    $box['classes'][] = 'newsroom_item_container';
    // Get active column.
    if ($num_columns == 2 && $newsroom_row_number % 2 == 0) {
      $active_column = 2;
    }

    $columns_newsroom[$active_column]['visible'] = TRUE;
    $columns_newsroom[$active_column]['content'] .= '<div id="' . $box['id'] . '" class="' . implode(' ', $box['classes']) . '">'; /* add "highlighted" classname to display that block as highlighted (ie press releases, speeches) */
    $columns_newsroom[$active_column]['content'] .= '<a name="' . $box['id'] . '"></a>';
    $columns_newsroom[$active_column]['content'] .= '<h3 class="newsroom_title">' . $box['title'] . '</h3>';
    $columns_newsroom[$active_column]['content'] .= $box['block']['content'];
    $columns_newsroom[$active_column]['content'] .= '<div class="newsroom_more">' . $box['list_link'] . '</div>';
    $columns_newsroom[$active_column]['content'] .= "</div>";

    $newsroom_row_number++;
  }

  // 2 columns so display both.
  if ($columns_newsroom[2]['visible'] === TRUE) {
    $newsroom_content .= '<div class="nr_column_1 nr_column">' . $columns_newsroom[1]['content'] . '</div>';
    $newsroom_content .= '<div class="nr_column_2 nr_column">' . $columns_newsroom[2]['content'] . '</div>';
  }
  // 1 column only.
  else {
    $newsroom_content .= '<div class="nr_column_single">' . $columns_newsroom[1]['content'] . '</div>';
  }
  return $newsroom_content;
}

/**
 * Sort newsroom boxes.
 *
 * @param array $a
 *   Newsroom box.
 * @param array $b
 *   Newsroom box.
 *
 * @return bool
 *   Value.
 */
function _nexteuropa_newsroom_sort_newsroom_boxes(array $a, array $b) {
  // Highligths at begining or end - based on setting.
  if ($a['highlight'] !== $b['highlight']) {
    return variable_get('newsroom_display_highlights_begin', 0) ? $a['highlight'] == FALSE : $a['highlight'] == TRUE;
  }
  // Sort Agenda before or after highlighted  - based on setting.
  if ($a['highlight'] && ($a['agenda'] !== $b['agenda'])) {
    return variable_get('newsroom_agenda_after_highlights', 0) ? $a['agenda'] == TRUE : $a['agenda'] == FALSE;
  }
  // Sort based on last update  - based on setting.
  if (variable_get('newsroom_order_by_last_update', 0)) {
    return $a['last_update'] < $b['last_update'];
  }
  else {
    return $a['weight'] > $b['weight'];
  }
}

/**
 * Fetch the contents of a newsroom box.
 *
 * @return array
 *   view
 */
function _nexteuropa_newsroom_fetch_content_view($view_arguments, $newsroom_grouping_term_name, $default_view_display, $sticky, $full_display, $topic_operator) {
  $view = views_get_view('newsroom_page_content');
  if (!is_object($view)) {
    return FALSE;
  }

  $view->newsroom_display_type = FALSE;
  $view->newsroom_type_name = $newsroom_grouping_term_name === NEWSROOM_CALENDAR_BLOCK ? t('Calendar') : $newsroom_grouping_term_name->name;
  $view->set_arguments($view_arguments);
  $view->set_display($default_view_display);
  $view->sticky = $sticky;

  // Use topic operator from newsroom selection for topic context filter.
  $arguments_settings = $view->display[$view->current_display]->handler->get_option('arguments');
  if ($topic_operator != NEWSROOM_TOPIC_OPERATOR_OR && isset($arguments_settings['newsroom_term_node_tid_depth']['use_and'])) {
    $arguments_settings['newsroom_term_node_tid_depth']['use_and'] = 1;
    $view->display[$view->current_display]->handler->set_option('arguments', $arguments_settings);
  }

  $pager = $view->display_handler->get_option('pager');
  if ($full_display == TRUE) {
    $pager['type'] = 'full';
    $pager['options']['items_per_page'] = '15';
    $pager['options']['offset'] = '0';
    $pager['options']['id'] = '0';
  }
  elseif ($default_view_display !== 'agenda') {
    // Customizeable item number for non agenda displays.
    $variable_name = '';
    // Number of items per block.
    if (_nexteuropa_newsroom_type_is_highlighted($newsroom_grouping_term_name)) {
      // Highlighted type, home | not home.
      $variable_name = $sticky ? 'newsroom_summary_home_block_num_highlighted_items' : 'newsroom_summary_block_num_highlighted_items';
    }
    else {
      // Not highlighted type, home | not home.
      $variable_name = $sticky ? 'newsroom_summary_home_block_num_items' : 'newsroom_summary_block_num_items';
    }

    $pager['options']['items_per_page'] = variable_get($variable_name, 3);
  }

  $view->display_handler->set_option('pager', $pager);
  $view->execute_display($default_view_display);

  return array('block' => $view->execute_display($default_view_display), 'view' => $view);
}

/**
 * Term ids of item types to be used in agenda.
 *
 * @return array
 *   tids
 */
function _nexteuropa_newsroom_agenda_types() {
  $newsroom_agenda_types = &drupal_static(__FUNCTION__);
  if (!isset($newsroom_agenda_types)) {
    $cache = cache_get('newsroom:agenda_types');
    if ($cache) {
      $newsroom_agenda_types = $cache->data;
    }
    else {
      $query = new EntityFieldQuery();
      $query->entityCondition('entity_type', 'taxonomy_term')
          ->entityCondition('bundle', NEWSROOM_TYPE_VOCABULARY)
          ->fieldCondition('field_newsroom_type', 'value', array(
            'events',
            'consultation_funding',
            'agenda',
          )
          );
      $result = $query->execute();
      $newsroom_agenda_types = isset($result['taxonomy_term']) ? $result['taxonomy_term'] : FALSE;
      cache_set('newsroom:agenda_types', $newsroom_agenda_types, 'cache_newsroom', time() + 360);
    }
  }
  return $newsroom_agenda_types;
}

/**
 * Merges a term_tid and its children into one array.
 *
 * @param int $term_tid
 *   Term id.
 * @param int $term_vid
 *   Vid id.
 *
 * @return array.
 *   tids
 */
function _nexteuropa_newsroom_get_children($term_tid, $term_vid) {
  // We need parent ID also in the output array to use it in query.
  $parent_children_tids = array($term_tid);
  $children_tids = array_keys(taxonomy_get_children($term_tid, $term_vid));
  if (count($children_tids) > 0) {
    $parent_children_tids = array_merge($parent_children_tids, $children_tids);
  }
  return implode('+', $parent_children_tids);
}

/**
 * Implements hook_views_query_alter().
 */
function nexteuropa_newsroom_views_query_alter(&$view, &$query) {
  if ($view->name === 'newsroom_page_content' && (!isset($view->sticky) || !$view->sticky)) {
    foreach ($query->where[1]['conditions'] as $key => $condition) {
      if ($condition['field'] == 'node.sticky') {
        unset($query->where[1]['conditions'][$key]);
      }
    }
  }
}

/**
 * Implements hook_node_view().
 */
function nexteuropa_newsroom_node_view($node, $view_mode, $langcode) {
  if ($node->type == 'newsroom_item' && $view_mode == 'full') {
    $node_wrapper = entity_metadata_wrapper('node', $node);
    $type = $node_wrapper->field_newsroom_item_type->value();
    $type_wrapper = entity_metadata_wrapper('taxonomy_term', $type);

    // Redirect item if redirection is forced for this type.
    // Except for editors who can import items.
    if (!user_access(NEWSROOM_IMPORT_ACCESS)) {
      // Only if we have a main link.
      if ($type && $node_wrapper->__isset('field_newsroom_item_main_link')) {
        if (_nexteuropa_newsroom_item_type_teaser_only_settings($node_wrapper) == NEWSROOM_CLICKTHROUGH_FORCE) {
          $link = $node_wrapper->field_newsroom_item_main_link->value();
          drupal_goto($link['url'], array(), 301);
        }
      }
    }

    // Fetch menu context for item so we can have an active trail set for it.
    // Basically we try to find a menu item (node||term) that has the same Topic
    // associated than the NR item has as primary topic (or as normal topic).
    $path = FALSE;

    // Get primary topic if any.
    $primary_topics = $node_wrapper->field_primary_topic->value();
    if (!empty($primary_topics)) {
      $primary_topics = !is_array($primary_topics) ? array($primary_topics) : $primary_topics;
    }
    else {
      $primary_topics = array();
    }
    // Get regular topics.
    $topics = $node_wrapper->field_newsroom_topics->value();
    if (!empty($topics)) {
      $topics = !is_array($topics) ? array($topics) : $topics;
    }
    else {
      $topics = array();
    }

    $topics = array_merge($primary_topics, $topics);
    // Loop through topics (start with primary) to find menu item.
    foreach ($topics as $topic) {
      if ($path = _nexteuropa_newsroom_fetch_active_menu($topic->tid)) {
        // Set menu item and stop the search.
        menu_tree_set_path('main-menu', $path);
        break;
      }
    }

    // Custom main link title per type.
    if ($type && $node_wrapper->__isset('field_newsroom_item_main_link')) {
      // Case there is a custom read more text set, change it.
      if ($type_wrapper->field_read_more_text->value()) {
        $node->content['field_newsroom_item_main_link'][0]['#element']['title'] = $type_wrapper->field_read_more_text->value();
      }
    }

    // Custom resposible person label per type.
    if ($type && $node_wrapper->__isset('field_newsroom_item_speaker')) {
      // Case there is a custom read more text set, change it.
      if ($type_wrapper->field_responsible_person_label->value()) {
        $node->content['field_newsroom_item_speaker']['#title'] = $type_wrapper->field_responsible_person_label->value();
      }
    }
  }
}

/**
 * Helper to retrieve a mlid for a given path.
 *
 * @param string $topic_ids
 *   Topic term ids.
 *
 * @return array
 *   Field data.
 */
function _nexteuropa_newsroom_get_topic_entities($topic_ids) {
  $topic_ids = is_array($topic_ids) ? $topic_ids : array($topic_ids);
  $key = 'newsroom:get_topic_entities:' . md5(implode('', $topic_ids));
  $cache = cache_get($key);
  if ($cache) {
    $data = $cache->data;
  }
  else {
    $query = db_select('field_data_field_associated_newsroom_topic', 'f')
        ->fields('f')
        ->condition('f.field_associated_newsroom_topic_tid', $topic_ids)
        ->execute();
    $data = _nexteuropa_newsroom_pdo_to_array($query);

    cache_set($key, $data);
  }
  return $data;
}

/**
 * Helper function to serialize PDO object into an array.
 */
function _nexteuropa_newsroom_pdo_to_array($query) {
  $data = array();
  if ($query) {
    while ($result = $query->fetchAssoc()) {
      $data[] = $result;
    }
  }

  return $data;
}

/**
 * Active menu for newsroom items.
 *
 * Returns wich menu item should be active for a newsroom item
 * based on the assigned topics.
 */
function _nexteuropa_newsroom_fetch_active_menu($topic_id) {
  $path = FALSE;

  // Check if they are added to menu.
  $menu_items = array();
  // Fetch enities associated to topic using the special field.
  $topic_entities = _nexteuropa_newsroom_get_topic_entities($topic_id);

  if (count($topic_entities) > 0) {
    foreach ($topic_entities as $entity) {
      // Could use entity_uri() but we would have to load the full entity...
      $menu_link_items = _nexteuropa_newsroom_get_menu_by_path(str_replace('_', '/', $entity['entity_type']) . '/' . $entity['entity_id']);

      if ($menu_link_items !== FALSE) {
        foreach ($menu_link_items as $menu_item) {
          $menu_items[] = $menu_item;
        }
      }
    }
  }

  if (count($menu_items) > 0) {
    // Favor terms over nodes and lower entity ID in case we have multiple.
    usort($menu_items, function ($a, $b) {
      if ($a['router_path'] == 'taxonomy/term/%' && $b['router_path'] == 'node/%') {
        return -1;
      }
      elseif ($a['router_path'] == 'node/%' && $b['router_path'] == 'taxonomy/term/%') {
        return 1;
      }
      else {
        if ($a['plid'] == $b['plid']) {
          if ($a['weight'] == $b['weight']) {
            if ($a['mlid'] == $b['mlid']) {
              return 0;
            }
            else {
              return $a['mlid'] < $b['mlid'] ? -1 : 1;
            }
          }
          else {
            return $a['weight'] < $b['weight'] ? -1 : 1;
          }
        }
        else {
          return $a['plid'] < $b['plid'] ? -1 : 1;
        }
      }
    });

    $menu_item_link = array_shift($menu_items);
    $path = $menu_item_link['link_path'];
  }

  return $path;
}

/**
 * Finds a menu item for a given path.
 */
function _nexteuropa_newsroom_get_menu_by_path($path) {
  $key = 'newsroom:get_menu_by_path:' . md5($path);
  $cache = cache_get($key);
  if ($cache) {
    $data = $cache->data;
  }
  else {
    $query = db_select('menu_links', 'ml')
        ->fields('ml')
        ->condition('ml.link_path', $path)
        ->execute();
    $data = _nexteuropa_newsroom_pdo_to_array($query);
    cache_set($key, $data);
  }
  return $data;
}

/**
 * Controls access to page based on IP (newsroom server) and role.
 */
function _nexteuropa_nexteuropa_newsroom_item_import_access() {
  $allowed_ips = array_map('trim', explode(',', variable_get('newsroom_allowed_ips')));
  return user_access(NEWSROOM_IMPORT_ACCESS) ? TRUE : in_array(ip_address(), $allowed_ips);
}

/**
 * Imports or deletes a single taxonomy term item based on real newsroom ID.
 */
function _nexteuropa_newsroom_taxonomy_term_importer($field_title, $redirect_path, $field_name, $url, $importer_id, $tid = 0, $delete = FALSE, $reimport = FALSE) {

  if ($tid == 0) {
    drupal_not_found();
    drupal_exit();
  }

  if ($delete) {
    $terms = _nexteuropa_newsroom_technical_fields_to_tid($field_name, $tid);
    if ($terms) {
      taxonomy_term_delete($terms[0]);

      $message = t('Newsroom %2 tid: %1 deleted',
        array(
          '%1' => implode(', ', $terms),
          '%2' => $field_title,
        )
      );
      watchdog('newsroom', $message);
      drupal_set_message($message);
      return '';
    }
    else {
      drupal_not_found();
      drupal_exit();
    }
  }
  else {
    _nexteuropa_newsroom_run_importer($url, $importer_id);
    $path = $redirect_path . '/' . $tid;
    if ($reimport) {
      drupal_goto($path);
    }
    return l(t('Go to Newsroom @field_title', array('@field_title' => $field_title)), $path);
  }
}

/**
 * Imports or deletes a single news item based on the original newsroom ID.
 */
function _nexteuropa_nexteuropa_newsroom_item_importer($newsroom_id = 0, $delete = FALSE, $reimport = FALSE) {
  global $_newsroom_universe_url;

  if ($newsroom_id == 0) {
    drupal_not_found();
    drupal_exit();
  }

  if ($delete) {
    $newsroom_item = _nexteuropa_newsroom_get_newsroom_item_by_id($newsroom_id);
    if ($newsroom_item) {
      $nids_to_delete = array_keys($newsroom_item);
      node_delete_multiple($nids_to_delete);
      $message = t('Newsroom Item nid: %1 deleted', array('%1' => implode(', ', $nids_to_delete)));
      watchdog('newsroom', $message);
      drupal_set_message($message);
      return '';
    }
    else {
      drupal_not_found();
      drupal_exit();
    }
  }
  else {
    // Prepare URLs for importers and get feed importer ID.
    $url = $_newsroom_universe_url . variable_get('newsroom_single_item_import_segment', NEWSROOM_ITEM_SEGMENT) . $newsroom_id;
    _nexteuropa_newsroom_run_importer($url, NEWSROOM_ITEM_IMPORTER);
    $path = 'news-redirect/' . $newsroom_id;
    if ($reimport) {
      drupal_goto($path);
    }
    return l(t('Go to Newsroom Item'), $path);
  }
}

/**
 * Call newsroom items import with the certain URL.
 *
 * @param string $url
 *   URL to call.
 */
function _nexteuropa_newsroom_run_importer($url, $importer_id) {
  // Load the Feeds Source object.
  $source = feeds_source($importer_id);
  $config = $source->getConfig();
  // @TODO deal with the case if we don't have an item setup.
  $additional_config = array(
    'FeedsHTTPFetcher' => array(
      'source' => $url,
    ),
  );
  $source->setConfig(array_merge($config, $additional_config));
  // Make sure we force the import of the item.
  $processor_config = $source->importer->processor->getConfig();
  $source->importer->processor->setConfig(array_merge($processor_config, $additional_config));
  $source->import();
  $source->delete();
}

/**
 * Get newsroom item by Id.
 */
function _nexteuropa_newsroom_get_newsroom_item_by_id($newsroom_id = 0) {
  $newsroom_data = &drupal_static(__FUNCTION__);
  $key = 'newsroom:newsroom_item_by_id:' . $newsroom_id;
  if (!isset($newsroom_data)) {
    $cache = cache_get($key);
    if ($cache) {
      $newsroom_data = $cache->data;
    }
    else {
      $query = new EntityFieldQuery();
      $newsroom_item = $query
        ->entityCondition('entity_type', 'node')
        ->fieldCondition('field_newsroom_item_id', 'value', $newsroom_id, '=')
        ->execute();
      $newsroom_data = isset($newsroom_item['node']) ? $newsroom_item['node'] : FALSE;
      cache_set($key, $newsroom_data, 'cache_newsroom', time() + 360);
    }
  }
  return $newsroom_data;
}

/**
 * Shortcut to delete a Newsroom Type.
 *
 * @param int $type_id
 *   Original type id.
 *
 * @return string
 *   Message.
 */
function _nexteuropa_newsroom_type_delete($type_id = 0) {
  return _nexteuropa_newsroom_type_importer($type_id, TRUE);
}

/**
 * Shortcut to delete a Newsroom Type.
 *
 * @param int $type_id
 *   Original type id.
 * @param bool $reimport
 *   Redirect to newsroom page or display message.
 *
 * @return string
 *   Message.
 */
function _nexteuropa_newsroom_type_import($type_id = 0, $reimport = NULL) {
  return _nexteuropa_newsroom_type_importer($type_id, FALSE, $reimport == 'reimport');
}

/**
 * Calls general method to import taxonomy term with params for newsroom type.
 *
 * @param int $type_id
 *   Original type id.
 * @param bool $delete
 *   Defines delete or import item.
 * @param bool $reimport
 *   Redirect to newsroom page or display message.
 *
 * @return string
 *   Message
 */
function _nexteuropa_newsroom_type_importer($type_id, $delete = FALSE, $reimport = FALSE) {
  global $_newsroom_universe_url;

  $url = $_newsroom_universe_url . variable_get('newsroom_single_type_import_segment', NEWSROOM_TYPE_SEGMENT) . $type_id;
  return _nexteuropa_newsroom_taxonomy_term_importer('Type', 'news-type-redirect', 'field_newsroom_type_id', $url, NEWSROOM_TYPE_IMPORTER, $type_id, $delete, $reimport);
}

/**
 * Shortcut to delete a Newsroom Service.
 *
 * @param int $service_id
 *   Original service id.
 *
 * @return string
 *   Message
 */
function _nexteuropa_newsroom_service_delete($service_id = 0) {
  return _nexteuropa_newsroom_service_importer($service_id, TRUE);
}

/**
 * Shortcut to delete a Newsroom Service.
 *
 * @param int $service_id
 *   Service taxonomy term id.
 * @param bool $reimport
 *   Redirect to newsroom page or display message.
 *
 * @return string
 *   Message.
 */
function _nexteuropa_newsroom_service_import($service_id = 0, $reimport = NULL) {
  return _nexteuropa_newsroom_service_importer($service_id, FALSE, $reimport == 'reimport');
}

/**
 * Calls general method to import taxonomy term with params for news service.
 *
 * @param int $service_id
 *   Original service id.
 * @param bool $delete
 *   Defines delete or import item.
 * @param bool $reimport
 *   Redirect to newsroom page or display message.
 *
 * @return string
 *   Message.
 */
function _nexteuropa_newsroom_service_importer($service_id, $delete = FALSE, $reimport = FALSE) {
  global $_newsroom_universe_url;
  $url = $_newsroom_universe_url . variable_get('newsroom_single_service_import_segment', NEWSROOM_SERVICE_SEGMENT) . $service_id;
  return _nexteuropa_newsroom_taxonomy_term_importer('Service', 'news-service-redirect', 'field_newsroom_service_id', $url, NEWSROOM_SERVICE_IMPORTER, $service_id, $delete, $reimport);
}

/**
 * Shortcut to delete a Newsroom Topic.
 *
 * @param int $topic_id
 *   Original topic id.
 *
 * @return string
 *   Message.
 */
function _nexteuropa_newsroom_topic_delete($topic_id = 0) {
  return _nexteuropa_newsroom_topic_importer($topic_id, TRUE);
}

/**
 * Shortcut to delete a Newsroom Topic.
 *
 * @param int $topic_id
 *   Original topic id.
 * @param bool $reimport
 *   Redirect to newsroom page or display message.
 *
 * @return string
 *   Message.
 */
function _nexteuropa_newsroom_topic_import($topic_id = 0, $reimport = NULL) {
  return _nexteuropa_newsroom_topic_importer($topic_id, FALSE, $reimport == 'reimport');
}

/**
 * Calls general method to import taxonomy term with params for newsroom topic.
 *
 * @param int $topic_id
 *   Original topic id.
 * @param bool $delete
 *   Defines delete or import item.
 * @param bool $reimport
 *   Redirect to newsroom page or display message.
 *
 * @return string
 *   Message
 */
function _nexteuropa_newsroom_topic_importer($topic_id, $delete = FALSE, $reimport = FALSE) {
  global $_newsroom_universe_url;
  $url = $_newsroom_universe_url . variable_get('newsroom_single_topic_import_segment', NEWSROOM_TOPIC_SEGMENT) . $topic_id;
  return _nexteuropa_newsroom_taxonomy_term_importer('Topic', 'news-topic-redirect', 'field_newsroom_topic_id', $url, NEWSROOM_TOPIC_IMPORTER, $topic_id, $delete, $reimport);
}

/**
 * Shortcut to delete a Newsroom Item.
 */
function _nexteuropa_newsroom_item_delete($newsroom_id = 0) {
  return _nexteuropa_nexteuropa_newsroom_item_importer($newsroom_id, TRUE);
}

/**
 * Shortcut to import a Newsroom Item.
 */
function _nexteuropa_newsroom_item_import($newsroom_id = 0, $reimport = NULL) {
  return _nexteuropa_nexteuropa_newsroom_item_importer($newsroom_id, FALSE, $reimport == 'reimport');
}

/**
 * Redirects to the Newsroom Item. With the Original Newsroom ID.
 */
function _nexteuropa_newsroom_item_redirect($newsroom_id = 0) {
  return _nexteuropa_newsroom_redirect('item', $newsroom_id);
}

/**
 * Redirects to the Newsroom Item Topic. With the Original Newsroom Topic ID.
 */
function _nexteuropa_newsroom_topic_redirect($topic_id = 0, $direct = 0) {
  return _nexteuropa_newsroom_redirect('topic', $topic_id, $direct);
}

/**
 * Redirects to the Newsroom Item Type. With the Original Newsroom Type ID.
 */
function _nexteuropa_newsroom_type_redirect($type_id = 0, $direct = 0) {
  return _nexteuropa_newsroom_redirect('type', $type_id, $direct);
}

/**
 * Redirects to the Newsroom Service. With the Original Newsroom Service ID.
 */
function _nexteuropa_newsroom_service_redirect($service_id = 0) {
  return _nexteuropa_newsroom_redirect('service', $service_id);
}

/**
 * Redirects to the Newsroom Item with the Original Newsroom ID.
 */
function _nexteuropa_newsroom_redirect($redirect_type = 'item', $param_1 = 0, $param_2 = 0) {
  if (!$param_1) {
    drupal_not_found();
  }

  $path = FALSE;
  switch ($redirect_type) {
    // Newsroom Article based on original newsroom ID.
    case 'item':
      $item = _nexteuropa_newsroom_get_newsroom_item_by_id($param_1);
      if (!empty($item)) {
        $item = array_shift($item);
        $path = 'node/' . $item->nid;
      }
      break;

    // Newsroom Item Type based on original import name.
    case 'type':
      $type = _nexteuropa_newsroom_technical_fields_to_tid('field_newsroom_type_id', $param_1);
      if ($type) {
        $type_term = taxonomy_term_load($type[0]);
        if (!empty($param_2)) {
          $path = 'taxonomy/term/' . $type_term->tid;
        }
        else {
          $path = _nexteuropa_newsroom_get_newsroom_url(pathauto_cleanstring($type_term->name));
        }
      }
      break;

    // Newsroom Chapter based on original newsroom topic ID.
    case 'topic':
      $topic = _nexteuropa_newsroom_technical_fields_to_tid('field_newsroom_topic_id', $param_1);
      if ($topic) {
        $topic_term = taxonomy_term_load($topic[0]);
        if (!empty($param_2)) {
          $path = 'taxonomy/term/' . $topic_term->tid;
        }
        else {
          $path = _nexteuropa_newsroom_get_newsroom_url('all', pathauto_cleanstring($topic_term->name));
        }
      }
      break;

    // Newsroom type and topic.
    case 'topic-type':
      $topic = _nexteuropa_newsroom_technical_fields_to_tid('field_newsroom_topic_id', $param_1);
      $type = _nexteuropa_newsroom_technical_fields_to_tid('field_newsroom_type_id', $param_2);
      if ($topic && $type) {
        $type_term = taxonomy_term_load($type[0]);
        $topic_term = taxonomy_term_load($topic[0]);
        $path = _nexteuropa_newsroom_get_newsroom_url(pathauto_cleanstring($type_term->name), pathauto_cleanstring($topic_term->name));
      }
      break;

    // Newsroom service.
    case 'service':
      $service = _nexteuropa_newsroom_technical_fields_to_tid('field_newsroom_service_id', $param_1);

      if ($service) {
        $taxonomy_term = taxonomy_term_load($service[0]);
        if ($taxonomy_term) {
          $path = 'taxonomy/term/' . $taxonomy_term->tid;
        }
      }
      break;
  }

  if ($path) {
    drupal_goto($path);
  }
  else {
    drupal_not_found();
  }
}

/**
 * Implements pre_render_hook().
 */
function nexteuropa_newsroom_views_pre_render(&$view) {
  // Mark items as new if a user did't see it before.
  if (user_is_logged_in() && $view->name == 'newsroom_page_content') {
    foreach ($view->result as $key => $result) {
      if ($result->node_created < time() - 14 * 86400) {
        continue;
      }

      $last_viewed = node_last_viewed($result->nid);

      if (empty($last_viewed)) {
        $new_title = empty($result->field_field_newsroom_item_short_title[0]['rendered']['#markup']) ? $result->field_title_field_et[0]['rendered']['#markup'] : $result->field_field_newsroom_item_short_title[0]['rendered']['#markup'];
        $view->result[$key]->field_field_newsroom_item_short_title[0]['rendered']['#markup'] = '<span class="itemFlag flagHot newItem">' . t('New') . '</span> ' . $new_title;
      }
    }
  }

  if ($view->name == 'newsroom') {

    // Replace [newsroom_url_prefix] for view area to site prefix
    // for example 'digital-agenda'.
    $areas = array('header', 'footer', 'empty');
    foreach ($areas as $area) {
      if (isset($view->$area)) {
        $area_item = $view->$area;
        foreach ($area_item as $key => $value) {
          if (isset($area_item[$key]->options['content'])) {
            $area_item[$key]->options['content'] = str_replace('[newsroom_url_prefix]', variable_get('newsroom_url_prefix', ''), $area_item[$key]->options['content']);
          }
        }
        $view->$area = $area_item;
      }
    }

    // TODO : find the solution to avoid No name in substitutions.
    if ($view->build_info['substitutions']['%2'] == 'No name') {
      $view->build_info['substitutions']['%2'] = '';
    }

    if (in_array($view->current_display, array('previous_events', 'previous_consultation_funding'))) {
      $view->build_info['title'] = str_replace('<span class="filter_type">', '<span class="filter_type"> Past ', $view->build_info['title']);
    }
    // If there is more than one parameter.
    if (count(explode(' ', $view->build_info['substitutions']['!1']) > 1)) {
      $view->build_info['substitutions']['%1'] = str_replace(' + ', ' & ', $view->build_info['substitutions']['%1']);
    }

    if ($view->build_info['substitutions']['!2'] == 'all') {
      if (isset($view->header['area_text_custom'])) {
        $view->header['area_text_custom']->options['content'] = str_replace('about %2', '', $view->header['area_text_custom']->options['content']);
      }
    }
    else {
      $view->build_info['title'] = str_replace('<span class="filter_topic">', '<span class="filter_topic">about ', $view->build_info['title']);
      if (count(explode(' ', $view->build_info['substitutions']['!2']) > 1)) {
        $view->build_info['substitutions']['%2'] = str_replace(' + ', ' & ', $view->build_info['substitutions']['%2']);
      }
    }

    if ($view->build_info['substitutions']['%1'] == '' && $view->build_info['substitutions']['%2'] == '' || $view->build_info['substitutions']['%1'] == '' && $view->build_info['substitutions']['%2'] == 'all') {
      $view->build_info['title'] = isset($view->display[$view->current_display]->display_options['title']) ? $view->display[$view->current_display]->display_options['title'] : $view->display['default']->display_options['title'];
    }

    // Include rendered entity from settings.
    if (isset($view->header['entity']) && isset($view->header['entity']->options['ui_name']) && $view->header['entity']->options['ui_name'] == 'embedded_node') {
      $patterns = trim(variable_get('newsroom_embedded_node_patterns', ''));
      $patterns = explode("\n", $patterns);
      foreach ($patterns as $pattern) {
        $pattern = explode('|', trim($pattern));
        // Verify pattern format.
        if (count($pattern) == 3) {
          // Check for a match with current arguments.
          if ($pattern[0] == $view->args[0] && $pattern[1] == $view->args[1] && is_numeric($pattern[2])) {
            $view->header['entity']->options['entity_id'] = $pattern[2];
            break;
          }
        }
      }
    }

    // Inculde Featured item per type only on first page.
    if (isset($view->header['view']) && isset($view->header['view']->options['ui_name']) && $view->header['view']->options['ui_name'] == 'featured') {
      $page = isset($_GET['page']) ? $_GET['page'] : NULL;
      if (!empty($page)) {
        unset($view->header['view']);
      }
    }
  }
}

/**
 * Preview view hook.
 *
 * @param object $view
 *   View entity.
 * @param int $display_id
 *   Display Id.
 * @param array $args
 *   Arguments.
 */
function nexteuropa_newsroom_views_pre_view(&$view, &$display_id, array &$args) {

  if ($view->name == 'newsletter_subscription') {
    // The proper context filter cannot be found for taxonomy term pages
    // so we set it manually.
    $current_path = menu_get_item();

    // Try to get proper taxonomy context filter.
    if ($current_path['path'] === 'taxonomy/term/%') {
      $taxonomy_term = NULL;
      $current_page_path = current_path();

      // Never sure what menu_callback will get you with.
      // A view overridding a taxo page.
      $url_tokens = explode('/', $current_page_path);
      if (isset($url_tokens[2]) && is_numeric($url_tokens[2])) {
        $taxonomy_term = taxonomy_term_load($url_tokens[2]);
      }

      if (!empty($taxonomy_term) && isset($taxonomy_term->field_associated_newsroom_topic) && !empty($taxonomy_term->field_associated_newsroom_topic)) {
        $has_newsroom_topic_argument = FALSE;
        // Check the current display.
        if (isset($view->display[$view->current_display]->handler->options['arguments'])) {
          foreach ($view->display[$view->current_display]->handler->options['arguments'] as $key => $argument) {
            // Check if this field taxonomy ref to newsroom_topic vocabulary.
            if ($argument['default_argument_type'] == 'taxonomy_tid'
              && isset($argument['default_argument_options']['vocabularies']['newsroom_topic'])) {
              $has_newsroom_topic_argument = TRUE;
              break;
            }
          }
        }

        // Check the default display, if we don't have ovverrides.
        if (isset($view->display['default']->handler->options['arguments'])) {
          foreach ($view->display['default']->handler->options['arguments'] as $key => $argument) {
            // Check if this field taxonomy ref to newsroom_topic vocabulary.
            if ($argument['default_argument_type'] == 'taxonomy_tid' &&
              isset($argument['default_argument_options']['vocabularies']['newsroom_topic'])) {
              $has_newsroom_topic_argument = TRUE;
              break;
            }
          }
        }

        // Set argument from the taxonomy associated newsroom topic.
        if ($has_newsroom_topic_argument) {
          $args = array($taxonomy_term->field_associated_newsroom_topic[LANGUAGE_NONE][0]['tid']);
        }
      }
    }
  }

  if ($view->name == 'newsroom') {
    $arguments_settings = $view->display[$view->current_display]->handler->get_option('arguments');
    // Select the appropriate display in case only one type is set.
    if ($display_id == 'default_newsroom' && isset($args[0]) && $args[0] !== $arguments_settings['term_node_tid_depth']['default_argument_options']['argument']) {
      $display_field = 'default';

      $is_previous = isset($args[2]) && $args[2] == 'previous';

      // Convert topic url part to taxonomy term id
      // and assign to arguments, because we use 'tids' validation.
      if (isset($args[1]) && !empty($args[1]) && $args[1] != 'all') {
        $topic = _nexteuropa_newsroom_taxonomy_term_from_request($args[1], $arguments_settings, 'term_node_tid_depth_1');

        if ($topic) {
          $args[1] = $topic->tid;
        }
      }

      $types = explode(' ', $args[0]);

      if (count($types) == 1) {
        // Convert type or topic url part to taxonomy term id
        // and assign to arguments, because we use 'tids' validation.
        $type = _nexteuropa_newsroom_taxonomy_term_from_request($types[0], $arguments_settings, 'term_node_tid_depth');

        if ($type) {
          $type = is_array($type) ? array_shift($type) : $type;
          // Take children types IDs and use them as argument
          // because we need to make search in children types also.
          $args[0] = _nexteuropa_newsroom_get_children($type->tid, $type->vid);

          $wrapper = entity_metadata_wrapper('taxonomy_term', $type);
          if ($wrapper->__isset('field_newsroom_type')) {
            $display_field = $wrapper->field_newsroom_type->value();
          }
        }

        switch ($display_field) {
          case 'events':
            $display = $is_previous ? 'previous_events' : 'events';
            break;

          case 'consultation_funding':
            $display = $is_previous ? 'previous_consultation_funding' : 'consultation_funding';
            break;

          default:
            $display = 'default_newsroom';
            break;
        }

        $view->set_display($display);
      }
    }
  }

  if ($view->name == 'newsroom_navigation') {
    $display = variable_get('newsroom_block_by', 'type');
    $router = menu_get_item();
    // Custom display for calendar pages.
    if (isset($router['path']) && $router['path'] == _nexteuropa_newsroom_get_newsroom_url('calendar')) {
      $display .= '_for_calendar';
    }
    $view->set_display($display);

    // Rewrite navigation urls from term name to tid if set.
    $newsroom_url_mode = variable_get('newsroom_url_mode', 'name');
    if ($newsroom_url_mode == 'tid') {
      $field_settings = $view->display[$view->current_display]->handler->get_option('fields');
      foreach ($field_settings as &$field_setting) {
        if (!empty($field_setting['alter']['path'])) {
          $field_setting['alter']['path'] = str_replace('[name]', '[tid]', $field_setting['alter']['path']);
        }
      }
      $view->display[$view->current_display]->handler->set_option('fields', $field_settings);
    }
  }
}

/**
 * Try to get taxonomy term.
 *
 * @param string $request
 *   URL request part.
 * @param array $argument_settings
 *   View arguments.
 */
function _nexteuropa_newsroom_taxonomy_term_from_request($request, array $argument_settings, $filter_field) {
  global $language;
  $curr_lang = $language->language;

  $taxonomy_term = NULL;
  if (is_int($request)) {
    $taxonomy_term = taxonomy_term_load($request);
    if ($taxonomy_term) {
      return $taxonomy_term;
    }
  }
  // Take vocabularies from context filter field.
  $vocabularies = isset($argument_settings[$filter_field]['validate_options']['vocabularies']) ? array_values($argument_settings[$filter_field]['validate_options']['vocabularies']) : array();

  if (count($vocabularies) > 0) {

    $taxonomy_terms = _nexteuropa_newsroom_get_term_from_vocabularies($vocabularies);

    // Compare taxonomy terms modified by pathauto with the current value
    // from the URL.
    if ($taxonomy_terms) {
      foreach ($taxonomy_terms as $term_item) {
        // Replace the name with translated value.
        $fullterm = taxonomy_term_load($term_item['tid']);
        $translation = field_get_items('taxonomy_term', $fullterm, 'name_field', $curr_lang);
        $term_item['name'] = $translation ? $translation[0]['safe_value'] : $term_item['name'];

        if (pathauto_cleanstring($term_item['name']) == $request) {
          $taxonomy_term = taxonomy_term_load($term_item['tid']);
          break;
        }
      }
    }
  }

  return $taxonomy_term;
}

/**
 * Term ids of item types to be used in agenda.
 *
 * @return array
 *   tids
 */
function _nexteuropa_newsroom_get_term_from_vocabularies($vocabularies = array()) {
  $key = 'newsroom:vocabulary_terms:' . md5(implode('', $vocabularies));

  $cache = cache_get($key);

  if ($cache) {
    $taxonomy_terms = $cache->data;
  }
  else {
    $query = db_select('taxonomy_term_data', 'td');
    $query->leftJoin('taxonomy_vocabulary', 'tv', 'td.vid = tv.vid');
    $query->fields('td');
    $query->fields('tv', array('machine_name'));
    $query->condition('tv.machine_name', $vocabularies);
    $taxonomy_terms = _nexteuropa_newsroom_pdo_to_array($query->execute());

    cache_set($key, $taxonomy_terms, 'cache_newsroom', time() + 360);
  }

  return $taxonomy_terms;
}

/**
 * Converts an option array from tid based to name based.
 *
 * @return array
 *   List of options.
 */
function _nexteuropa_newsroom_options_tid_to_name($options) {
  $options_names = array();
  foreach ($options as $option) {
    $options_names[drupal_strtolower(str_replace(' ', '-', trim($option, ' -')))] = $option;
  }
  return $options_names;
}

/**
 * Implements hook_theme().
 */
function nexteuropa_newsroom_theme($existing, $type, $theme, $path) {
  return array(
    'newsroom_agenda' => array(
      'file' => 'theme.inc',
      'path' => $path . '/theme',
    ),
    'newsroom_agenda_date' => array(
      'file' => 'theme.inc',
      'path' => $path . '/theme',
    ),
    'newsroom_zoomable_image' => array(
      'variables' => array(
        'image_output' => NULL,
        'path' => NULL,
        'image_style' => NULL,
        'title' => NULL,
        'copyright' => NULL,
        'caption' => NULL,
        'path_to_original' => NULL,
        'zoomable' => FALSE,
        'display_title' => FALSE,
      ),
      'template' => 'zoomable-image',
      'path' => $path . '/theme',
    ),
  );
}

/**
 * Implements hook_preprocess_views_viewnewsroom_preprocess_views_view().
 */
function nexteuropa_newsroom_preprocess_views_view(&$vars) {

  if ($vars['view']->name !== 'newsroom_page_content' || $vars['view']->current_display !== 'agenda') {
    return;
  }

  $agenda = _nexteuropa_newsroom_prepare_agenda($vars['view']);

  if ($agenda) {
    $vars['rows'] = theme('newsroom_agenda', $agenda);
  }
}

/**
 * Build a render array representing the events.
 *
 * @param object $view
 *   The view object.
 *
 * @return array
 *   A render array of events.
 */
function _nexteuropa_newsroom_prepare_agenda($view) {
  if (empty($view->result)) {
    return array();
  }
  $today = date('Y-m-d', time());
  $events = array();
  $renderer = $view->style_plugin->row_plugin;
  foreach ($view->result as $delta => $row) {
    // Render row to be able to use views for formatting the fields.
    $view->row_index = $delta;
    $rendered_row = $renderer->render($row);

    // Collect all fields for the customize options.
    $fields = array();
    // Collect only date fields.
    $date_fields = array();
    foreach ($view->field as $field_name => $field) {
      $fields[$field_name] = $view->style_plugin->get_field($delta, $field_name);
      if (fullcalendar_field_is_date($field)) {
        $date_fields[$field_name] = array(
          'value' => $field->get_items($row),
          'field_alias' => $field->field_alias,
          'field_name' => $field->field_info['field_name'],
          'field_info' => $field->field_info,
        );
      }
    }

    // If there are no date fields (gcal only), return.
    if (empty($date_fields)) {
      return $events;
    }

    // This should never happen, but just in case.
    if (!isset($row->_field_data)) {
      return $events;
    }

    $entities = array();
    $event = array();
    foreach ($date_fields as $field) {
      // If this row doesn't contain this entity, or if this entity has already
      // been processed, skip it.
      if (!isset($row->_field_data[$field['field_alias']])) {
        continue;
      }

      if (!isset($entities[$field['field_alias']])) {
        // Find the field's alias that refers to it's entity.
        $alias = $field['field_alias'];
        $entity = $row->_field_data[$alias]['entity'];
        $entity->entity_type = $row->_field_data[$alias]['entity_type'];

        list(,, $bundle) = entity_extract_ids($entity->entity_type, $entity);
        $entity->bundle = $bundle;
        $entity->eid = $row->{$alias};
        $entity->options = $view->style_options;

        // Store the current date field name for later.
        $entity->agenda_date_field = $field['field_name'];

        // Default URL.
        $uri = entity_uri($entity->entity_type, $entity);
        $entity->url = isset($uri['path']) ? $uri['path'] : '';
        // Fetch custom URL if needed.
        if (!empty($options['url'])) {
          $field_name = $options['url_field'];
          if (!empty($fields[$field_name])) {
            $entity->url = ltrim($fields[$field_name], '/');
          }
        }

        // Fetch custom title if needed.
        if (!isset($entity->title)) {
          $entity->title = '';
        }
        if (!empty($options['title'])) {
          $field_name = $options['title_field'];
          if (!empty($fields[$field_name])) {
            $entity->title = $fields[$field_name];
          }
        }

        $entities[$alias] = $entity;
      }

      $entity = $entities[$field['field_alias']];
      // Filter fields without value.
      if (!empty($field['value'])) {
        $instance = field_info_instance($entity->entity_type, $field['field_name'], $bundle);
        foreach ($field['value'] as $index => $item) {
          $classes = 'views-row clearfix';
          $dates = _nexteuropa_newsroom_process_dates($instance, $entity, $field['field_info'], $item['raw']);
          if (empty($dates)) {
            continue;
          }
          list($start, $end, $all_day, $single_day, $length) = $dates;

          $item_wrapper = entity_metadata_wrapper('node', $entity);
          $type = $item_wrapper->field_newsroom_item_type->raw();

          $classes .= ' type-' . $type;
          $classes .= $single_day ? ' single-day' : '';
          $classes .= date('Y-m-d', strtotime($start)) == $today ? ' starts' : '';
          $classes .= date('Y-m-d', strtotime($end)) == $today ? ' ends' : '';

          $event = array(
            '#type' => 'markup',
            '#markup' => $rendered_row,
            '#prefix' => '<div class="' . $classes . '">',
            '#suffix' => '</div>',
            'attributes' => array(
              'allDay' => $all_day,
              'singleDay' => $single_day,
              'start' => $start,
              'end' => $end,
              'length' => $length,
              'field' => $field['field_name'],
              'index' => $index,
            ),
          );
          // Duplicate records for each day in case it is multiple day event.
          $date = date('Y-m-d', strtotime($start));
          while (strtotime($date) <= strtotime($end)) {
            $events[$date][] = $event;
            $date = date('Y-m-d', strtotime('+1 day', strtotime($date)));
          }
        }
      }
    }
  }
  ksort($events);
  return $events;
}

/**
 * Process the dates, format them, and determine if it is all day.
 *
 * @param array $instance
 *   The field instance.
 * @param object $entity
 *   The entity object.
 * @param array $field
 *   The field info.
 * @param array $item
 *   The date item.
 *
 * @return array
 *   A numerically indexed array containing these elements:
 *   - 0: The start date object.
 *   - 1: The end date object.
 *   - 2: A Boolean representing whether the date is all day.
 */
function _nexteuropa_newsroom_process_dates(array $instance, $entity, array $field, array $item) {
  if (isset($item['db']['value'])) {
    $date1 = $item['db']['value'];
    date_timezone_set($date1, timezone_open($item['timezone']));
    $date2 = $item['db']['value2'];
    date_timezone_set($date2, timezone_open($item['timezone']));
  }
  else {
    $date = date_formatter_process($instance['display']['default']['type'], $entity->entity_type, $entity, $field, $instance, LANGUAGE_NONE, $item, $instance['display']['default']);
    if (empty($date['value']['local']['object'])) {
      return array();
    }

    $date1 = $date['value']['local']['object'];
    $date2 = $date['value2']['local']['object'];
  }

  // Allow modules to alter the date objects.
  $start = $date1->format(DATE_FORMAT_DATETIME);
  $end = $date2->format(DATE_FORMAT_DATETIME);
  $all_day = _nexteuropa_newsroom_date_all_day_field($field, $instance, $date1, $date2);
  $single_day = date('Y-m-d', strtotime($start)) == date('Y-m-d', strtotime($end));
  // Lenght of event in days.
  $length = (int) floor((strtotime($end) - strtotime($start)) / (60 * 60 * 24)) + 1;
  return array($start, $end, $all_day, $single_day, $length);
}

/**
 * Provide a wrapper around the deprecated date_field_all_day().
 *
 * @see date_all_day_field()
 * @see date_field_all_day()
 */
function _nexteuropa_newsroom_date_all_day_field($field, $instance, $date1, $date2 = NULL) {
  // Try the old function first since it is more likely to be available.
  if (function_exists('date_field_all_day')) {
    return date_field_all_day($field, $instance, $date1, $date2);
  }

  // Now try the new function.
  if (function_exists('date_all_day_field')) {
    return date_all_day_field($field, $instance, $date1, $date2);
  }

  // This means the old function has been removed, and they haven't enabled the
  // new module yet. All day events will be displayed as not all day.
  watchdog('newsroom', 'All day events will not function correctly until the Date All Day module is enabled.', array(), WATCHDOG_NOTICE);
  return FALSE;
}

/**
 * Implements hook_field_formatter_info().
 */
function nexteuropa_newsroom_field_formatter_info() {
  return array(
    'newsroom_main_link' => array(
      'label' => t('Newsroom Main Link'),
      'field types' => array('link_field'),
      'multiple values' => FIELD_BEHAVIOR_DEFAULT,
    ),
    'newsroom_pathauto' => array(
      'label' => t('Newsroom Path Auto'),
      'field types' => array('text'),
      'multiple values' => FIELD_BEHAVIOR_DEFAULT,
    ),
    'newsroom_zoomable_image' => array(
      'label' => t('Newsroom image'),
      'field types' => array('image'),
      'settings' => array(
        'image_style' => '',
        'display_title' => '',
        'display_copyright' => '',
        'display_caption' => '',
        'zoomable' => '',
      ),
    ),
  );
}

/**
 * Implements hook_field_formatter_settings_form().
 */
function nexteuropa_newsroom_field_formatter_settings_form($field, $instance, $view_mode, $form, &$form_state) {
  $display = $instance['display'][$view_mode];
  $settings = $display['settings'];
  $element = array();

  switch ($display['type']) {

    case 'newsroom_zoomable_image':
      $image_styles = image_style_options(FALSE, PASS_THROUGH);
      $element['image_style'] = array(
        '#title' => t('Image style'),
        '#type' => 'select',
        '#default_value' => $settings['image_style'],
        '#empty_option' => t('None (original image)'),
        '#options' => $image_styles,
      );
      $element['zoomable'] = array(
        '#title' => t('Allow zoom (to original in fancybox)'),
        '#type' => 'checkbox',
        '#default_value' => $settings['zoomable'],
      );
      $element['display_title'] = array(
        '#title' => t('Display title'),
        '#type' => 'checkbox',
        '#default_value' => $settings['display_title'],
      );
      $element['display_copyright'] = array(
        '#title' => t('Display copyright'),
        '#type' => 'checkbox',
        '#default_value' => $settings['display_copyright'],
      );
      $element['display_caption'] = array(
        '#title' => t('Display caption'),
        '#type' => 'checkbox',
        '#default_value' => $settings['display_caption'],
      );
      break;

    case 'newsroom_main_link':
      $element['display_type'] = array(
        '#title' => t('Type of display context'),
        '#type' => 'select',
        '#options' => array(
          'default' => t('Default'),
          'title' => t('Title only'),
          'teaser' => t('Teaser also displayed'),
        ),
        '#default_value' => $settings['display_type'],
      );

      break;
  }

  return $element;
}

/**
 * Implements hook_field_formatter_settings_summary().
 */
function nexteuropa_newsroom_field_formatter_settings_summary($field, $instance, $view_mode) {
  $display = $instance['display'][$view_mode];
  if ($display['type'] == 'newsroom_main_link') {
    if ($display['settings']['display_type']) {
      $options = array(
        'default' => t('Default'),
        'title' => t('Title only'),
        'teaser' => t('Teaser also displayed'),
      );

      return $options[$display['settings']['display_type']];
    }
    else {
      return t('Default');
    }
  }

  if ($display['type'] == 'newsroom_zoomable_image') {
    $settings = $display['settings'];
    $summary = array();
    $image_styles = image_style_options(FALSE, PASS_THROUGH);
    unset($image_styles['']);
    if (isset($image_styles[$settings['image_style']])) {
      $summary[] = t('Image style: @style', array('@style' => $image_styles[$settings['image_style']]));
    }
    else {
      $summary[] = t('Original image');
    }
    if ($settings['zoomable']) {
      $summary[] = t('Is zoomable');
    }
    if ($settings['display_title']) {
      $summary[] = t('Displays title');
    }
    if ($settings['display_copyright']) {
      $summary[] = t('Displays copyright');
    }
    return implode(',', $summary);
  }
  return '';
}

/**
 * Implements hook_field_formatter_view().
 */
function nexteuropa_newsroom_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
  $elements = array();

  switch ($display['type']) {
    case 'newsroom_pathauto':
      foreach ($items as $delta => $item) {
        $elements[$delta] = array('#markup' => pathauto_cleanstring($item['safe_value']));
      }
      break;

    case 'newsroom_main_link':
      foreach ($items as $delta => $item) {
        if (!empty($item['url'])) {

          $main_link_url = $item['url'];

          // Link to newsroom item by default.
          $item['url'] = 'node/' . $entity->nid;

          // If item is Teaser only.
          $wrapper = entity_metadata_wrapper('node', $entity);
          $click_through = _nexteuropa_newsroom_item_type_teaser_only_settings($wrapper);

          if ($click_through == NEWSROOM_CLICKTHROUGH_FORCE) {
            $item['url'] = $main_link_url;
          }
          elseif ($wrapper->field_newsroom_teaser_only->value()) {
            switch ($click_through) {
              case 'always':
                $item['url'] = $main_link_url;
                break;

              case 'from_teaser':
                if ($display['settings']['display_type'] == 'teaser') {
                  $item['url'] = $main_link_url;
                }
                break;
            }
          }
        }

        $elements[$delta] = array(
          '#theme' => 'link_formatter_link_absolute',
          '#element' => $item,
          '#field' => $instance,
          '#display' => $display,
        );
      }

      break;

    case 'newsroom_zoomable_image':
      global $language;

      foreach ($items as $delta => $item) {
        $image = array(
          'path' => $item['uri'],
        );
        $path_to_original = file_create_url($item['uri']);

        // Sets alt text.
        if (isset($item['field_file_image_alt_text'][$language->language][0])) {
          $image['alt'] = $item['field_file_image_alt_text'][$language->language][0]['safe_value'];
        }
        elseif (array_key_exists('alt', $item)) {
          $image['alt'] = $item['alt'];
        }

        // Sets zoomability.
        $zoomable = $display['settings']['zoomable'] ? TRUE : FALSE;

        // Sets title.
        $title = NULL;
        if (isset($item['field_file_image_title_text'][$language->language][0])) {
          $image['title'] = $item['field_file_image_title_text'][$language->language][0]['safe_value'];
          if ($display['settings']['display_title']) {
            $title = $item['field_file_image_title_text'][$language->language][0]['safe_value'];
          }
        }
        elseif (isset($item['title']) && drupal_strlen($item['title']) > 0) {
          $image['title'] = $item['title'];
        }

        $copyright = NULL;

        // Sets copyright.
        if ($display['settings']['display_copyright']) {
          if (isset($item['field_newsroom_copyrights'][$language->language][0])) {
            $copyright = $item['field_newsroom_copyrights'][$language->language][0]['safe_value'];
          }
        }

        // Sets copyright.
        $caption = '';
        if ($display['settings']['display_caption']) {
          if (isset($item['field_caption'][$language->language][0])) {
            $caption = $item['field_caption'][$language->language][0]['safe_value'];
          }
        }

        if (isset($item['attributes'])) {
          $image['attributes'] = $item['attributes'];
        }

        if (isset($item['width']) && isset($item['height'])) {
          $image['width'] = $item['width'];
          $image['height'] = $item['height'];
        }

        $image['title'] = $title;

        if ($display['settings']['image_style']) {
          $image['style_name'] = $display['settings']['image_style'];
          $image_output = theme('image_style', $image);
        }
        else {
          $image_output = theme('image', $image);
        }

        $elements[$delta] = array(
          '#theme' => 'newsroom_zoomable_image',
          '#copyright' => $copyright,
          '#caption' => $caption,
          '#image_output' => $image_output,
          '#path_to_original' => $path_to_original,
          '#zoomable' => $zoomable,
        );
      }
      break;
  }

  return $elements;
}

/**
 * Implements hook_entity_presave().
 */
function nexteuropa_newsroom_entity_presave($entity, $type) {
  if (isset($entity->_feed_changed) && isset($entity->changed)) {
    $entity->changed = $entity->_feed_changed;
  }
}

/**
 * Implements hook_feeds_after_save().
 */
function nexteuropa_newsroom_feeds_after_save(FeedsSource $source, $entity, $item, $entity_id) {
  if ($source->importer()->fetcher->id == 'newsroom_items_multilingual') {

    // TODO : find a better way to remove translation.
    $languages = language_list();
    $def_lang = language_default()->language;

    // Try to remove disabled translations, check the title for translation.
    foreach ($languages as $language) {
      // Check only active and skip the default language.
      if ($language->enabled && $language->language != $def_lang) {
        $config = $source->importer()->processor->getConfig();
        if (isset($config['mappings'])) {
          $xpath_expression = NULL;
          foreach ($config['mappings'] as $mapping) {
            if ($mapping['target'] == 'title_field:et:' . $language->language) {
              $xpath_expression = $mapping['source'];
              break;
            }
          }

          // If title is empty it means there is no translation.
          if (!empty($xpath_expression) && isset($item[$xpath_expression]) && empty($item[$xpath_expression])) {
            // Delete translation for the current language.
            $handler = entity_translation_get_handler('node', $entity);
            $handler->removeTranslation($language->language);
            field_attach_presave('node', $entity);
            field_attach_update('node', $entity);

            // It is necessary to clean the cache
            // to remove the translation completely.
            cache_clear_all($entity_id, 'cache_entity_node');
          }
        }

      }
    }

    if (isset($entity->field_illustrative_image[LANGUAGE_NONE][0]['fid']) && !empty($entity->field_illustrative_image[LANGUAGE_NONE][0]['fid'])) {

      $fields = array(
        'field_file_image_title_text' => 'title',
        'field_newsroom_copyrights' => 'copyright',
        'field_caption' => 'caption',
        'field_file_image_alt_text' => 'alt',
      );
      $fid = $entity->field_illustrative_image[LANGUAGE_NONE][0]['fid'];

      $file = file_load($fid);
      if ($file) {
        $config = $source->importer()->processor->getConfig();
        if (isset($config['mappings'])) {
          // Save default language at first.
          foreach ($config['mappings'] as $mapping) {
            foreach ($fields as $field => $field_name) {
              if ($mapping['target'] == 'field_illustrative_image:' . $field_name . ':et:' . $def_lang && !empty($mapping['source']) && isset($item[$mapping['source']]) && !empty($item[$mapping['source']])) {
                $file->$field = array($def_lang => array(0 => array('value' => $item[$mapping['source']])));
              }
            }
          }
          file_save($file);

          $handler = entity_translation_get_handler('file', $file);

          // Handle the rest of available translations.
          foreach ($config['mappings'] as $mapping) {
            foreach ($fields as $field => $field_name) {
              foreach ($languages as $language) {

                if ($language->language == $def_lang) {
                  continue;
                }

                if ($mapping['target'] == 'field_illustrative_image:' . $field_name . ':et:' . $language->language && !empty($mapping['source']) && isset($item[$mapping['source']]) && !empty($item[$mapping['source']])) {
                  $translation = array(
                    'translate' => 0,
                    'status' => 1,
                    'language' => $language->language,
                    'source' => $def_lang,
                  );
                  $values = array(
                    "$field" => array(
                      "$language->language" => array(
                        '0' => array(
                          'value' => $item[$mapping['source']],
                        ),
                      ),
                    ),
                  );
                  $handler->setTranslation($translation, $values);
                }
              }
            }
          }
        }
        file_save($file);
        cache_clear_all($fid, 'cache_entity_file');
      }
    }
  }
}

/**
 * Implements hook_feeds_set_target().
 */
function nexteuropa_newsroom_feeds_set_target(FeedsSource $source, $entity, $target, $feed_element) {
  $entity->_feed_changed = feeds_to_unixtime($feed_element, REQUEST_TIME);
}

/**
 * Implements hook_feeds_processor_targets_alter().
 */
function nexteuropa_newsroom_feeds_processor_targets_alter(&$targets, $entity_type, $bundle_name) {
  $targets['_feed_changed'] = array(
    'name' => t('Changed date'),
    'description' => t('The UNIX time when a !entity_type has been changed.', array('!entity_type' => $entity_type)),
    'callback' => 'newsroom_feeds_set_target',
  );

  // We expose image additional fields to feeds mapper. So later we can use
  // these values to save them to file's fields.
  $field_names = array(
    'field_file_image_title_text' => 'field_illustrative_image:title:et:',
    'field_newsroom_copyrights' => 'field_illustrative_image:copyright:et:',
    'field_caption' => 'field_illustrative_image:caption:et:',
    'field_file_image_alt_text' => 'field_illustrative_image:alt:et:',
  );

  $fields = array();
  $languages = language_list();
  foreach ($languages as $language) {
    // Check only active and skip the default language.
    if ($language->enabled) {
      foreach ($field_names as $field_name) {
        $fields[] = $field_name . $language->language;
      }
    }
  }

  foreach (field_info_instances('file', 'image') as $name => $instance) {
    if (in_array($name, array_keys($field_names))) {
      foreach ($fields as $field) {

        $targets[$field] = array(
          'name' => t('Image:@name', array('@name' => $field)),
          'callback' => NULL,
          'description' => t('The @label field of the image.', array('@label' => $field)),
          'real_target' => $field,
        );
      }
    }
  }
}

/**
 * Implements hook_views_handlers().
 */
function nexteuropa_newsroom_views_handlers() {
  return array(
    'handlers' => array(
      'newsroom_views_handler_field_taxonomy' => array(
        'parent' => 'views_handler_field_taxonomy',
        'path' => drupal_get_path('module', 'nexteuropa_newsroom') . '/views',
      ),
    ),
  );
}
