From f2fc05b2f693c7d88bc5ffc87cbcf271e2ee7ca3 Mon Sep 17 00:00:00 2001
From: Mark Carver <mark.carver@me.com>
Date: Wed, 12 Mar 2014 20:50:42 -0500
Subject: [PATCH] Issue #2201779 by Mark Carver | MD3:
 bootstrap_process_html_tag() is too aggressive.

---
 theme/system/html-tag.vars.php | 45 +++++++++++++++++++++++++++++++++++-------
 1 file changed, 38 insertions(+), 7 deletions(-)

diff --git a/theme/system/html-tag.vars.php b/theme/system/html-tag.vars.php
index fb86067..ee1ce25 100644
--- a/theme/system/html-tag.vars.php
+++ b/theme/system/html-tag.vars.php
@@ -8,13 +8,44 @@
  * Implements hook_process_html_tag().
  */
 function bootstrap_process_html_tag(&$variables) {
-  $tag = &$variables['element'];
-  if ($tag['#tag'] == 'style' || $tag['#tag'] == 'script') {
-    // Remove redundant type attribute and CDATA comments.
-    unset($tag['#attributes']['type'], $tag['#value_prefix'], $tag['#value_suffix']);
-    // Remove media="all" but leave others unaffected.
-    if (isset($tag['#attributes']['media']) && $tag['#attributes']['media'] === 'all') {
-      unset($tag['#attributes']['media']);
+  // Reference the element and tag name for easier coding below.
+  $element = &$variables['element'];
+  $tag = $element['#tag'];
+  if ($tag === 'style' || $tag === 'script') {
+    // Remove default "type" attribute. Leave others unaffected as it may be
+    // needed and used for other purposes.
+    // @see http://stackoverflow.com/a/5265361/1226717
+    // @see https://drupal.org/node/2201779
+    $types = array(
+      // @see http://www.w3.org/TR/html5/document-metadata.html#attr-style-type
+      'style' => 'text/css',
+      // @see http://www.w3.org/TR/html5/scripting-1.html#attr-script-type
+      'script' => 'text/javascript',
+    );
+    if (!empty($element['#attributes']['type']) && $element['#attributes']['type'] === $types[$tag]) {
+      unset($element['#attributes']['type']);
+    }
+
+    // Remove CDATA comments. CDATA is only required for DOCTYPES that are XML
+    // based, HTML5 is not.
+    $cdata_prefix = array(
+      'style' => "\n<!--/*--><![CDATA[/*><!--*/\n",
+      'script' => "\n<!--//--><![CDATA[//><!--\n",
+    );
+    $cdata_suffix = array(
+      'style' => "\n/*]]>*/-->\n",
+      'script' => "\n//--><!]]>\n",
+    );
+    if (
+      !empty($element['#value_prefix']) && $element['#value_prefix'] === $cdata_prefix[$tag] &&
+      !empty($element['#value_suffix']) && $element['#value_suffix'] === $cdata_suffix[$tag]
+    ) {
+      unset($element['#value_prefix'], $element['#value_suffix']);
+    }
+
+    // Remove the "media=all" attribute, leave others unaffected.
+    if (isset($element['#attributes']['media']) && $element['#attributes']['media'] === 'all') {
+      unset($element['#attributes']['media']);
     }
   }
 }
-- 
2.5.0

